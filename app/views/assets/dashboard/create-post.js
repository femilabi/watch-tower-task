var F=Object.defineProperty;var N=(u,t,e)=>t in u?F(u,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):u[t]=e;var f=(u,t,e)=>N(u,typeof t!="symbol"?t+"":t,e);import"../root.js";import"../create-editor.js";import{A as M,d,b as h,t as U,f as q,i as L,a as B,I as R,c as s,m as b,S as v,M as V}from"../index2.js";import"../common4.js";/* empty css              *//* empty css          *//* empty css      *//* empty css               */const{error:E}=M(),T=JSON.parse(d.categoryToCostMap),_=h('input[name="blog_author"]');window.addEventListener("profile-update",({detail:u})=>{d.userName=u,_.value=u});U(".open-pay-publish",".page-close-side-bar",".side-bar");new q(h(".tag-input"));L(h(".meta-info"));L(h(".links-list"));const w=new CrimsonEditor(B("blog-content-editor"),{mode:"light"});setTimeout(()=>{h(".page-content").scrollTo(0,0)},10);const G=B("cover-image-oreview");new R({editModalId:"image-edit",inputFieldId:"cover-image-input",onFileChange:u=>{G.src=URL.createObjectURL(u[0])}});const p={"competitor-promotion":d.competitorPromotion.split(","),"unpaid-link":d.unpaidLink.split(","),"blocked-domain":d.blockedDomain.split(","),gambling:d.gambling.split(","),adult:d.adult.split(",")},j={"competitor-promotion":{title:"Competitor link Detected",message:"This post contains content promoting a business in violation of our non-compete guidelines. Please modify the post to comply with our policies"},gambling:{title:"Casino & Gambling Content Detected",message:"This post contains casino and gambling content, which is not allowed on our platform. Please modify the post to comply with our guidelines."},adult:{title:"Adult Content Detected",message:"This post contains adult content, which is not allowed on our platform. Please modify the post to comply with our guidelines."},"unpaid-link":{title:"Unpaid Link Detected",message:"Our system has detected an unpaid link previously inserted in your submission. To proceed, you may either remove the link and continue with the 'Pay Later' option or choose 'Pay & Publish Now' to complete your submission immediately."},"blocked-domain":{title:"Block Domain Detected",message:"Our system has detected a URL from a blocked domain in your submission. Please remove the link or contact our webmaster for assistance to proceed."}};class J{constructor({editor:t}){f(this,"editor");f(this,"categoryRegex");f(this,"alertParent");f(this,"animationConfig",{duration:800,easing:"cubic-bezier(.17,.67,.16,.99)",fill:"forwards"});f(this,"timeoutId",null);this.editor=t,this.categoryRegex=new RegExp(Object.values(p).flat().map(e=>`\\b(${e})\\b`).join("|"),"gi"),this.alertParent=document.querySelector(".page-content > section > .blog-editor-wrapper > .alert-wrapper"),this.contentCategories={gambling:p.gambling,adult:p.adult},this.hrefCategories={"competitor-promotion":p["competitor-promotion"],"unpaid-link":p["unpaid-link"],"blocked-domain":p["blocked-domain"]},this.init()}init(){w.lexicalEditor.registerUpdateListener(()=>{const t=this.scanContent();this.timeoutId&&clearTimeout(this.timeoutId),this.timeoutId=setTimeout(()=>{this.timeoutId=null,this.processDetectedCategories(t)},500)}),w.registerObjectionableWordsDetector([...p.gambling,...p.adult])}createAlert({type:t="warning",message:e="",title:i}){const o=s("div","animation-wrapper"),n=s("div",`admin-alert ${t}`),a=s("span","icon"),r=b("warning",28);a.appendChild(r);const l=s("div","content"),m=s("h2",void 0,i),c=s("p",void 0,e),C=s("a",void 0,"See our guidelines");return C.setAttribute("href","https://www.filmdistrictdubai.com/"),l.appendChild(m),l.appendChild(c),l.appendChild(C),n.appendChild(a),n.appendChild(l),o.appendChild(n),o.style.opacity="0",o.style.transform="scale(0.8)",o.style.height="0px",o.open=y=>{y.prepend(o),requestAnimationFrame(()=>{o.animate({height:o.scrollHeight+"px",marginBottom:"24px"},this.animationConfig);const P=o.animate({transform:"scale(1)",opacity:"1"},{...this.animationConfig,delay:300});P.onfinish=()=>{P.commitStyles(),P.cancel(),o.style.height="auto"}})},o.close=()=>{o.animate({transform:"scale(0.5)",opacity:"0"},this.animationConfig);const y=o.animate({height:"0px",marginBottom:"0px"},{...this.animationConfig,delay:300});y.onfinish=()=>{o.remove()}},o}scanContent(){const t=[...w.editorWorkSpace.childNodes].map(r=>r.textContent||r.innerText||"").join(" "),e={},i=t.match(this.categoryRegex);i&&i.forEach(r=>{Object.keys(this.contentCategories).forEach(l=>{p[l].includes(r.toLowerCase())&&(e[l]||(e[l]=new Set),e[l].add(r.toLowerCase()))})});const o=w.editorWorkSpace.querySelectorAll("a"),n=[];o.forEach(r=>{var m;const l=((m=r.getAttribute("href"))==null?void 0:m.toLowerCase())||"";Object.keys(this.hrefCategories).forEach(c=>{this.hrefCategories[c].some(y=>l.includes(y.toLowerCase()))&&(e[c]||(e[c]=new Set),n.push({category:c,href:l,element:r}),e[c].add(l))})});const a=new CustomEvent("content-violation",{detail:{violations:n,detectedCategories:e}});return window.dispatchEvent(a),e}processDetectedCategories(t){const e=Object.keys(t),i=this.alertParent;e.forEach(o=>{if(!i.querySelector(`[data-category="${o}"]`)){const a=this.createAlert(j[o]);a.firstElementChild.setAttribute("data-category",o),a.open(i)}}),Array.from(i.children).filter(o=>!e.includes(o.firstElementChild.dataset.category)).forEach(o=>{o.close()})}}new J({editor:w});const $=h('[name="post_title"]'),H=h('[name="post_unique"]');$.oninput=function(){const u=this.value;u&&(H.value=u.toString().toLowerCase().trim().replace(/[^a-z0-9\s-]/g,"").replace(/\s+/g,"-").replace(/-+/g,"-"))};const g=Intl.NumberFormat("en-us",{style:"currency",currency:"USD"}),k={easing:"cubic-bezier(.24,.67,.08,.99)",duration:700,fill:"forwards"},W=h('[data-name="post_category"]');class z{constructor({editor:t,container:e,form:i}){this.editor=t,this.container=e,this.linksCount=0,this.costPerLink=parseFloat(T[W.getValue()]),this.linksCountElement=null,this.linksTotalCostElement=null,this.isFreeMode=!1,this.links=null,this.linkContainer=null,this.publishButton=null,this.payPublishButton=null,this.payLaterPublishButton=null,this.form=i,this.hasViolation=!1,this.submitter=null,this.hasPassedLeastWordCount=!1,this.minWordCount=parseInt(d.minWordCount),this.isSubmitting=!1,this.formData=null,this.init()}init(){this.initEditor(),this.initViolationDetector(),this.initForm(),this.monitorWordCount(),this.monitorCategoryChange()}createPaymentSummarySection(){const t=s("div","payment-summary-wrapper"),e=s("section","payment-summary"),i=s("header"),o=s("h2",void 0,"Payment Summary"),{detail:n,value:a}=this.createDetail("Total Links",this.linksCount),{detail:r,value:l}=this.createDetail("Cost per link",g.format(this.costPerLink)),{detail:m,value:c}=this.createDetail("Total Cost",g.format(this.linksCount*this.costPerLink));return this.createLinksList(),i.append(o),e.append(i,n,r,m,this.linkContainer),t.append(e),this.costPerLinkElementValue=l,this.linksCountElement=a,this.linksTotalCostElement=c,t}createPublishButton(){const t=s("div","publish-button-wrapper"),e=s("button","publish pay-publish dynamic-button clickable"),i=s("span","idle","Publish");return e.append(i),t.append(e),v(e),{publishButtonWrapper:t,publishButton:e}}createPayNowPublishButton(){const t=s("div","publish-button-wrapper"),e=s("button","pay-publish dynamic-button clickable"),i=s("span","idle",""),o=s("span",void 0,"Pay & Publish Now"),n=b("paper-plane-tilt");return i.append(o,n),e.append(i),t.append(e),v(e),{publishButtonWrapper:t,publishButton:e}}createPayLaterPublishButton(){const t=s("div","publish-button-wrapper"),e=s("button","pay-later-publish dynamic-button clickable"),i=s("span","idle",""),o=s("span",void 0,"Pay Later & Publish"),n=b("timer");return i.append(o,n),e.append(i),t.append(e),v(e),{publishButtonWrapper:t,publishButton:e}}createDetail(t,e){const i=s("div","detail"),o=s("div","title",t),n=s("div","value",e);return i.append(o,n),{detail:i,title:o,value:n}}createLinksList(){this.linkContainer=s("div","links-list");const t=s("header","toggle"),e=s("h3"),i=s("button","section-drop-down-control",void 0,{type:"button","aria-label":"Dropdown control"});i.append(b("caret-down",16,"0 0 24 24"));const o=s("div","drop-down",void 0,{"data-default-closed":"true"});this.linksList=s("ul"),o.append(this.linksList),t.append(e,i),this.linkContainer.append(t,o),L(this.linkContainer)}initEditor(){this.editor.lexicalEditor.registerUpdateListener(async()=>{var e;const t=this.editor.editorWorkSpace.querySelectorAll("a");this.links=[...t].map(i=>i.getAttribute("href")).join(","),this.linksCount=t.length,this.linksCount>0?(await this.activatePaymentMode(),(e=this.linksList)==null||e.replaceChildren(...[...t].map(i=>{const o=document.createElement("li"),n=document.createElement("a");return n.setAttribute("href",i.getAttribute("href")),n.setAttribute("target","_blank"),n.textContent=i.getAttribute("href"),o.appendChild(n),o})),this.linksCountElement&&(this.linksCountElement.textContent=this.linksCount),this.linksTotalCostElement&&(this.linksTotalCostElement.textContent=g.format(this.linksCount*this.costPerLink))):this.activateFreeMode()})}async activateFreeMode(){if(this.linksList=null,this.linkContainer=null,!this.isFreeMode){this.isFreeMode=!0;const t=this.container.children;t.length>0&&await Promise.all([...t].map(o=>this.animateElementOut(o)));const{publishButtonWrapper:e,publishButton:i}=this.createPublishButton();this.publishButton=i,this.animateElementIn(e,this.container)}}async activatePaymentMode(){if(this.isFreeMode){this.isFreeMode=!1;const t=this.createPaymentSummarySection(),{publishButtonWrapper:e,publishButton:i}=this.createPayNowPublishButton(),{publishButtonWrapper:o,publishButton:n}=this.createPayLaterPublishButton();this.payPublishButton=i,this.payLaterPublishButton=n;const a=this.container.children;a.length>0&&await Promise.all([...a].map(r=>this.animateElementOut(r))),this.animateElementIn(t,this.container),this.animateElementIn(e,this.container),this.animateElementIn(o,this.container)}}initViolationDetector(){window.addEventListener("content-violation",t=>{const{detail:{detectedCategories:e,violations:i}}=t;this.hasViolation=Object.keys(e).length!==0,!this.hasViolation?this.enablePaymentButtons():this.disablePaymentButtons(),this.editor.editorWorkSpace.querySelectorAll("a").forEach(a=>{a.style.padding="",a.style.borderRadius="",a.style.outline="";const r=i.find(l=>l.element===a);r&&r.category==="unpaid-link"&&(a.style.padding="4px",a.style.borderRadius="4px",a.style.outline="1px dashed #FFBB00")}),Object.keys(e).length>0?(this.hasViolation=!0,this.disablePaymentButtons()):(this.hasViolation=!1,this.enablePaymentButtons())})}async uploadPost(t){if(this.isSubmitting)return;this.isSubmitting=!0,this.formData.append("pay_status",t),this.formData.append("post_hrefs",this.links),this.formData.append("post_links",JSON.stringify([...this.editor.editorWorkSpace.querySelectorAll("a")].map((i,o)=>({url:i.getAttribute("href"),anchor:i.innerText,index:o}))));const e=this;try{const i=new XMLHttpRequest;i.upload.addEventListener("progress",function(o){const n=o.loaded/o.total*100;e.submitter.progress(n)}),await new Promise((o,n)=>{i.addEventListener("load",function(){try{const a=JSON.parse(i.response);i.status>=200&&i.status<300&&a.status?(e.submitter.success(),setTimeout(()=>{window.location.href=a.redirect},2e3),o()):(e.submitter.error(),E(a.message,5e3),n(new Error("Error Uploading Post")))}catch(a){throw e.submitter.error(),E("Sorry an an Error Occured!, Please try again.",5e3),n(),a}}),i.addEventListener("error",()=>{e.submitter.error(),n(new Error("Network error occurred"))}),i.addEventListener("timeout",()=>{e.submitter.error(),n(new Error("Request timed out"))}),i.open("POST","/api/v1/guestblog/create-post",!0),i.timeout=3e4,i.send(e.formData)})}catch(i){throw i}finally{this.isSubmitting=!1}}payNowUploadPost(){const t=new FormData(this.form),e=this.editor.editorWorkSpace.querySelectorAll("a");t.append("post_hrefs",[...e].map(n=>n.href).join(","));const{modal:i,paypalButtonWrapper:o}=this.createPaymentSummaryDialogue();document.body.append(i),this.initPaypalButton(o,i,t)}payLaterUploadPost(){this.uploadPost("pending")}createPaymentSummaryDialogue(){var x;const t=s("div","overflow",void 0,{role:"dialogue","data-modal-element":"",id:"payment-modal","data-modal-title":"","aria-label":"Payment Dialogue"}),e=s("div","content-wrapper"),i=s("div","content"),o=s("header"),n=b("thumbs-up",117),a=s("h2",void 0,"Pay & Publish Now");o.append(n,a);const r=s("div","summary"),l=this.createSummaryGroup(),m=this.createSummaryItem("customer-name","Customer Name",d.userName);l.append(m);const c=this.createSummaryGroup(),C=this.createSummaryItem("blog-title","Blog Title",(x=this.form.post_title)==null?void 0:x.value);c.append(C);const y=this.createSummaryGroup("total-links"),P=this.createSummaryItem("","Total Links",this.linksCount),I=this.createSummaryItem("cost-per-link","Cost per Link",g.format(this.costPerLink));y.append(P,I);const S=this.createSummaryGroup("total"),O=this.createSummaryItem("total","Total",g.format(this.costPerLink*this.linksCount));S.append(O),r.append(l,c,y,S);const D=s("div",void 0,void 0,{id:"paypal-pay-button-wrapper"});return i.append(o,r,D),e.append(i),t.append(e),V(t),window.addEventListener("modal-close",A=>{A.detail===t&&(this.submitter&&this.submitter.idle(),setTimeout(()=>{t.remove()},1e3))},{once:!0}),{modal:t,paypalButtonWrapper:D}}initForm(){this.form.addEventListener("submit",async t=>{if(t.preventDefault(),this.hasViolation||!this.hasPassedLeastWordCount)return;const e=t.submitter;this.submitter=e,this.formData=new FormData(this.form);try{await this.validatePost(),e===this.publishButton&&this.linksCount<=0&&this.isFreeMode?this.uploadPost("now"):e===this.payPublishButton?this.payNowUploadPost():e===this.payLaterPublishButton&&this.payLaterUploadPost()}catch(i){E(i.message,5e3)}})}createSummaryGroup(t){return s("div",`summary-group ${t||""}`)}createSummaryItem(t,e,i){const o=s("div",`summary-item ${t||""}`),n=s("div","title",e),a=s("div","value",i);return o.append(n,a),o}animateElementOut(t){if(t.parentElement)return new Promise(e=>{t.animate({transform:["scale(1)","scale(0.5)"],opacity:["1","0"]},k);const i=t.animate({width:[t.offsetWidth+"px","0px"],height:[t.offsetHeight+"px","0px"],marginBottom:["24px","0px"]},{...k,delay:300});i.onfinish=()=>{t.remove(),e()}})}animateElementIn(t,e){if(e)return t.style.transform="scale(0.5)",t.style.opacity="0",t.style.width="0px",t.style.height="0px",e.append(t),new Promise(i=>{t.animate({width:["0px","100%"],height:["0px","100%"],marginBottom:["0px","24px"]},k);const o=t.animate({transform:["scale(0.5)","scale(1)"],opacity:["0","1"]},{...k,delay:300});o.onfinish=()=>{i()}})}async initPaypalButton(t,e){const i=this;i.submitter.loading();let o=0;try{window.paypal.Buttons({style:{color:"silver",shape:"rect",borderRadius:10,layout:"vertical"},onInit(){i.getPostPrice().then(n=>{o=n,e.open()}).catch(n=>{throw new Error(n.message)})},onError(n){console.log("PayPal Error:"+n),i.submitter.error()},async createOrder(){const n=new FormData;n.append("amount",o),n.append("currency","USD");const r=await(await fetch("/api/v1/payment/guestblog/paypal-order",{method:"POST",body:n})).json();return console.log(r),r.data},async onApprove(n,a){try{await i.uploadPost("paid"),i.submitter.success()}catch(r){console.log(r),i.submitter.error()}finally{e.close()}}}).render(t)}catch(n){throw console.log(n),n(err.message,5e3),e.open(),i.submitter.error(),n}}async validatePost(){try{return await this.sendData("/api/v1/guestblog/validate-post",this.formData),!0}catch(t){throw new Error(t.message)}}async getPostPrice(){return this.formData.append("post_hrefs",this.links),(await this.sendData("/api/v1/guestblog/post-charges",this.formData)).postAmount}disablePaymentButtons(){(!this.hasPassedLeastWordCount||this.hasViolation)&&setTimeout(()=>{[this.payLaterPublishButton,this.payPublishButton,this.publishButton].filter(Boolean).forEach(t=>t.disabled=!0)},200)}enablePaymentButtons(){this.hasPassedLeastWordCount&&!this.hasViolation&&setTimeout(()=>{[this.payLaterPublishButton,this.payPublishButton,this.publishButton].filter(Boolean).forEach(t=>t.disabled=!1)},200)}monitorWordCount(){const t=this.editor.editorElement.parentElement.firstElementChild.lastElementChild,e=s("div"),i=`Minimum word count: ${this.minWordCount}`,o=b("circle-check",20,"0 0 16 16");e.append(i,o);const n=s("div"),a=`Minimum word count: ${this.minWordCount}`,r=b("circle-check",20,"0 0 16 16");n.append(a,r),t.append(e,n),this.editor.lexicalEditor.registerUpdateListener(async()=>{const l=(this.editor.editorWorkSpace.textContent.match(/\S+/g)||[]).length;l>=this.minWordCount?(this.hasPassedLeastWordCount=!0,this.enablePaymentButtons()):(this.hasPassedLeastWordCount=!1,this.disablePaymentButtons()),n.style.width=l/this.minWordCount*100+"%",l/this.minWordCount>=1?n.classList.add("complete"):n.classList.remove("complete")})}monitorCategoryChange(){window.addEventListener("option-selected",t=>{const{customSelect:e,value:i}=t.detail;e===W&&(this.costPerLink=T[i],this.costPerLinkElementValue&&(this.costPerLinkElementValue.textContent=g.format(this.costPerLink)),this.linksTotalCostElement&&(this.linksTotalCostElement.textContent=g.format(this.linksCount*this.costPerLink)))})}async sendData(t,e){return new Promise((i,o)=>{const n=new XMLHttpRequest;n.addEventListener("load",function(){try{const l=JSON.parse(n.response);n.status>=200&&n.status<300?i(l):o(new Error(l.message||"Request failed"))}catch{o(new Error("Invalid JSON response"))}}),n.addEventListener("error",()=>{o(new Error("Network error occurred"))}),n.addEventListener("timeout",()=>{o(new Error("Request timed out"))});const a=e instanceof FormData,r=!a&&typeof e=="object";try{n.open("POST",t,!0),n.timeout=3e4,r&&n.setRequestHeader("Content-Type","application/json"),n.send(a?e:JSON.stringify(e))}catch{o(new Error("Failed to send request"))}})}}new z({editor:w,container:B("payment-wrapper"),form:h("form.page-content")});

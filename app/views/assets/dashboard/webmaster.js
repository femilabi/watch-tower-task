var h=Object.defineProperty;var v=(d,e,s)=>e in d?h(d,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):d[e]=s;var t=(d,e,s)=>v(d,typeof e!="symbol"?e+"":e,s);import"../root.js";import{n as l}from"../index3.js";import{d as n}from"../index2.js";import"../common4.js";import{C as I}from"../common3.js";/* empty css      *//* empty css               */const r={delivered_all:"delivered_all"};class m{constructor(){t(this,"chatSelects",[]);t(this,"chatSelectsMap",{});t(this,"conversationsMap",{});t(this,"websocket");t(this,"selectedChatIndidcator");t(this,"selectedChatId");t(this,"emptyChatView");t(this,"userId",n.userId);t(this,"deviceId",l(10));t(this,"conversation",null);this.conversationId=n.conversationId,this.socketUrl=`${n.socketUrl}?deviceId=${this.deviceId}&userId=${this.userId}`,this.websocket=new WebSocket(this.socketUrl),this.init()}init(){this.initConversation(),this.initWebsocketListener(),this.emitReadAllChat()}initConversation(){this.conversation=new I({conversationId:this.conversationId,websocket:this.websocket,userId:this.userId,deviceId:this.deviceId,isAdmin:!1,maxFileSize:n.maxFileSize})}initWebsocketListener(){this.conversation=this.websocket,this.websocket.addEventListener("message",e=>{var o;const s=JSON.parse(e.data);switch(s.type){case"message_delivered":s.deviceId===this.deviceId&&this.sendMessage({type:"read_message",sender_id:this.userId,conversation_id:s.conversation_id,deviceId:this.deviceId});break;case"message_read":setTimeout(()=>{var a;const i=(a=document.querySelectorAll)==null?void 0:a.call(document,"[data-status]");i==null||i.forEach(c=>{c.setAttribute("data-status","read")})},1100);break;case"conversatoin_read":{const i=(o=document.querySelectorAll)==null?void 0:o.call(document,"[data-status]");i==null||i.forEach(a=>{a.setAttribute("data-status","read")})}break;case r.delivered_all:{if(this.deviceId===s.deviceId)return;window.dispatchEvent(new CustomEvent(r.delivered_all));break}}}),this.websocket.addEventListener("close",()=>{setTimeout(()=>{this.websocket=new WebSocket(this.socketUrl),this.initWebsocketListener()},1e3)})}sendMessage(e){this.websocket.send(JSON.stringify(e))}emitReadAllChat(){this.websocket.addEventListener("open",()=>{this.sendMessage({type:"delivered_all",sender_id:this.userId,conversation_id:this.conversationId,deviceId:this.deviceId})})}}new m;

var le=Object.defineProperty;var ce=(C,e,t)=>e in C?le(C,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):C[e]=t;var h=(C,e,t)=>ce(C,typeof e!="symbol"?e+"":e,t);import{n as N}from"./index3.js";import{m as y,d as de,g as ie,b as H,c as g}from"./index2.js";function Z(C,e){const t=document.createElement("a");t.href=C,t.download=e,document.body.appendChild(t),t.click(),document.body.removeChild(t)}function d(C,e,t,i){const s=document.createElement(C);return e&&s.classList.add(...e.trim().split(" ")),t&&(s.innerHTML=t),i&&Object.entries(i).forEach(([n,a])=>{s.setAttribute(n,a)}),s}const B={duration:1200,fill:"forwards",easing:"cubic-bezier(.48,.01,0,1)"};function he(C){const e=typeof C=="number"?C:C.size,t=e/1024,i=t/1024,s=i/1024,n=s/1024,a=n/1024;return a>=1?`${a.toFixed(2)} PB`:n>=1?`${n.toFixed(2)} TB`:s>=1?`${s.toFixed(2)} GB`:i>=1?`${i.toFixed(2)} MB`:t>=1?`${t.toFixed(2)} KB`:`${e.toFixed(2)} B`}const pe={image:["jpg","jpeg","png","webp","svg"],video:["mp4","avi","webm"],document:["css","zip","js","doc","docx","ppt","pptx","xslx","pdf"],others:["rar"]};function ae(C){const e=C.split(".").pop().toLowerCase().split(/\#|\?/)[0];for(const[t,i]of Object.entries(pe))if(i.includes(e))return t;return"others"}class J{constructor({file:e,onUploadComplete:t,idleElement:i,container:s}){h(this,"file",null);h(this,"onUploadComplete",()=>{});h(this,"idleElement",d("div"));h(this,"AnimationConfig",{duration:1e3,fill:"forwards",easing:"cubic-bezier(.48,.01,0,1)"});h(this,"container",d("div"));h(this,"abortController",new AbortController);h(this,"retryButton",d("button"));h(this,"retryButtonContainer",d("div"));h(this,"sipnnerWrapper",d("div"));h(this,"sipnnerPath",d("div"));h(this,"remoteURL","");h(this,"onUploadProgress",()=>{});this.file=e,this.onUploadComplete=t||this.onUploadComplete,this.idleElement=i||this.idleElement,this.container=s||this.container,this.xmlHttpRequest=new XMLHttpRequest,this.init()}init(){this.removeIdleElement(),this.appendSpinner(),this.createRetryButton(),this.uploadFile()}removeIdleElement(){this.idleElement.animate({transform:["scale(1)","scale(0.5)"],opacity:["1","0"]},{...this.AnimationConfig,delay:800})}appendSpinner(){const{spinner:e,onProgres:t}=this.createSpinner();e.style.transform="scale(0.5)",e.style.opacity="0",this.container.appendChild(e),this.onUploadProgress=t,e.style.transform="scale(0.5)",e.style.opacity="0",e.animate({transform:["scale(0.5)","scale(1)"],opacity:["0","1"]},{...this.AnimationConfig,delay:1e3})}createSpinner(){const e=d("div","spinner-wrapper");e.style.zIndex="2";const t=document.createElementNS("http://www.w3.org/2000/svg","svg"),i=document.createElementNS("http://www.w3.org/2000/svg","path");t.setAttribute("fill","none"),t.setAttribute("width","100"),t.setAttribute("height","100"),t.setAttribute("viewBox","0 0 182 182"),i.setAttribute("d","M175 91C175 102.031 172.827 112.954 168.606 123.145C164.384 133.337 158.197 142.597 150.397 150.397C142.597 158.197 133.337 164.384 123.145 168.606C112.954 172.827 102.031 175 91 175C79.969 175 69.0459 172.827 58.8546 168.606C48.6632 164.384 39.4031 158.197 31.603 150.397C23.8029 142.597 17.6155 133.337 13.3941 123.145C9.17272 112.954 7 102.031 7 91C7 79.969 9.17273 69.0459 13.3941 58.8546C17.6155 48.6632 23.8029 39.4031 31.603 31.603C39.4032 23.8029 48.6633 17.6155 58.8546 13.3941C69.046 9.17272 79.969 7 91 7C102.031 7 112.954 9.17273 123.145 13.3941C133.337 17.6155 142.597 23.8029 150.397 31.603C158.197 39.4032 164.384 48.6633 168.606 58.8546C172.827 69.046 175 79.969 175 91L175 91Z"),i.setAttribute("stroke","white"),i.setAttribute("stroke-width","13"),i.setAttribute("stroke-linecap","round"),i.setAttribute("stroke-linejoin","round"),t.appendChild(i);const s=i.getTotalLength();i.setAttribute("stroke-dasharray",s),i.setAttribute("stroke-dashoffset",.5*s);const n=(c=.5)=>{i.animate({strokeDashoffset:(1-c)*s},this.AnimationConfig)};t.animate({transform:["rotate(0deg)","rotate(360deg)"]},{duration:2e3,easing:"linear",iterations:1/0});const a=d("button","abort-button clickable"),o=document.createElementNS("http://www.w3.org/2000/svg","svg"),r=document.createElementNS("http://www.w3.org/2000/svg","path"),l=document.createElementNS("http://www.w3.org/2000/svg","path");return o.setAttribute("width","75"),o.setAttribute("height","75"),o.setAttribute("viewBox","0 0 75 75"),r.setAttribute("d","M6.45166 7.1908L68.5485 67.8091"),r.setAttribute("stroke","white"),r.setAttribute("stroke-width","11.8"),r.setAttribute("stroke-linecap","round"),l.setAttribute("d","M6.81909 68.181L68.1811 6.81899"),l.setAttribute("stroke","white"),l.setAttribute("stroke-width","11.8"),l.setAttribute("stroke-linecap","round"),o.append(r,l),a.onclick=()=>{this.cancelUpload()},a.append(o),e.append(t,a),this.sipnnerWrapper=e,this.sipnnerPath=i,{spinner:e,onProgres:n}}createRetryButton(){this.retryButtonContainer=d("div","retry-button-container"),this.retryButton=d("button","retry-button clickable");const e=y("retry",12,"0 0 24 24");this.retryButton.onclick=()=>{this.retryUpload()},this.retryButtonContainer.style.transform="scale(0.5)",this.retryButtonContainer.style.opacity="0",this.retryButtonContainer.style.zIndex="0",this.retryButtonContainer.appendChild(this.retryButton),this.container.appendChild(this.retryButtonContainer),this.retryButton.append(e,"Retry")}cancelUpload(){var e;(e=this.xmlHttpRequest)==null||e.abort(),this.sipnnerWrapper.animate({transform:["scale(1)","scale(0.5)"],opacity:["1","0"],zIndex:["2","0"]},this.AnimationConfig),this.retryButtonContainer.animate({transform:["scale(0.5)","scale(1)"],opacity:["0","1"],zIndex:["0","2"]},{...this.AnimationConfig,delay:200}),this.abortController.abort()}uploadFile(){this.onUploadProgress(0);const e=new FormData;e.append("file",this.file.file),this.xmlHttpRequest.addEventListener("progress",t=>{if(t.lengthComputable){if(t.total===0)return;this.onUploadProgress(t.loaded/t.total)}else this.onUploadProgress(1)}),this.xmlHttpRequest.addEventListener("load",t=>{if(this.xmlHttpRequest.status!==200){this.cancelUpload();return}this.uploadComplete(JSON.parse(this.xmlHttpRequest.response).data)}),this.xmlHttpRequest.addEventListener("error",t=>{this.cancelUpload()}),this.xmlHttpRequest.open("POST",de.fileUploadApiUrl),this.xmlHttpRequest.send(e)}retryUpload(){this.retryButtonContainer.animate({transform:["scale(1)","scale(0.5)"],opacity:["1","0"],zIndex:["2","0"]},this.AnimationConfig),this.sipnnerWrapper.style.transform="scale(0.5)",this.sipnnerWrapper.style.opacity="0",this.sipnnerWrapper.animate({transform:["scale(0.5)","scale(1)"],opacity:["0","1"],zIndex:["0","2"]},{...this.AnimationConfig,delay:200}),this.uploadFile()}uploadComplete({name:e,url:t}){this.onUploadComplete({id:this.file.id,remoteURL:t,size:this.file.file.size,name:e}),this.sipnnerWrapper.animate({transform:["scale(1)","scale(0.5)"],opacity:["1","0"],zIndex:["2","0"]},this.AnimationConfig),this.idleElement.animate({transform:["scale(0.5)","scale(1)"],opacity:["0","1"]},{...this.AnimationConfig,delay:200}),this.retryButtonContainer.style.pointerEvents="none",this.sipnnerWrapper.style.pointerEvents="none"}}class me{constructor({chat:e,message:t}){h(this,"chat");h(this,"message");h(this,"selectedChats",[]);this.chat=e,this.message=t,this.init()}init(){this.createForwardModal(),this.openForwardModal()}createForwardModal(){const e=d("div","forward-wrapper"),t=d("div","forward-modal"),i=d("div","forward-header"),s=d("div","forward-title","Forward"),n=d("button","close-forward"),a=y("cancel",18,"0 0 25 25");n.appendChild(a),n.onclick=()=>{this.closeForwardModal()};const{replyWrapper:o}=this.chat.createReplyMessage(this.message,!1),r=d("div","forward-search-wrapper"),l=y("search",20,"0 0 24 24"),c=d("input","forward-search-input",void 0,{type:"text",placeHolder:"Search Chats"}),p=d("div","chat-list-wrapper"),m=d("ul","chat-list"),f=d("ul","chat-head-list");Object.keys(this.chat.chatSelectsMap).map(w=>{const E=this.chat.chatSelectsMap[w],I=E.querySelector("img").src,L=E.querySelector("h3").textContent,M=d("div","forward-chat-wrapper"),S=d("div","forward-chat"),W=d("div","chat-data"),U=d("img","chat-avatar",void 0,{src:I}),V=d("p","chat-name",L),k=d("input","chat-checkbox",void 0,{type:"checkbox",defaultChecked:!1,name:"selected-chat"});W.append(U,V),S.append(W,k),M.appendChild(S),M.setAttribute("chat-key",w),m.appendChild(M);const P={id:w,image:I,name:L};S.onclick=()=>{this.selectedChats.some($=>$.id===w)?(k.checked=!1,this.removeFromSelectedChats(P,f,m)):(k.checked=!0,this.addToSelectedChats(P,f,m))}});let x;c.oninput=()=>{clearTimeout(x),x=setTimeout(()=>{[...m.children].forEach(w=>{var I;if((I=w.querySelector("p"))==null?void 0:I.textContent.toLowerCase().includes(c.value.toLowerCase())){if(w.classList.contains("hide")&&w.classList.replace("hide","show"),!w.classList.contains("show"))return;w.classList.add("show")}else w.classList.contains("show")&&w.classList.replace("show","hide"),w.classList.add("hide")})},300)},r.append(l,c),i.append(s,n),p.append(f,m);const v=d("div","forward-button-wrapper");this.forwardButton=d("button","forward-button clickable","Forward",{disabled:!0}),v.append(this.forwardButton),this.forwardButton.onclick=()=>{this.chat.forwardMessage(this.message.message.text.trim(),this.selectedChats.map(w=>w.id)),this.closeForwardModal()},t.append(i,o,r,p,v),e.append(t),this.forwardModal=e}openForwardModal(){this.forwardModal,this.message.parentElement.parentElement.appendChild(this.forwardModal)}closeForwardModal(){this.forwardModal.remove(),this.forwardModal=null}addToSelectedChats(e,t,i){this.selectedChats.push(e),this.forwardButton.disabled=!1;const s=d("div","chat-head-wrapper"),n=d("div","chat-head"),a=d("img","chat-head-image",void 0,{src:e.image,alt:e.name}),o=d("div","chat-head-name",e.name),r=d("button","remove-chat-head-button clickable");r.appendChild(y("close",12,"0 0 24 24")),r.onclick=()=>{this.removeFromSelectedChats(e,t,i)},n.append(a,o,r),s.append(n),s.style.opacity="0",s.style.transform="scale(0.5)",s.style.height="0px",s.style.width="0px",s.setAttribute("chat-key",e.id),t.prepend(s),s.animate({height:["0px",s.scrollHeight+"px"],width:["0px",s.scrollWidth+"px"],marginBottom:["0px","16px"],marginRight:["0px","16px"]},{...B,duration:800}),setTimeout(()=>{s.animate({transform:["scale(0.5)","scale(1)"],opacity:["0","1"]},{...B,duration:800})},400)}removeFromSelectedChats(e,t,i){this.selectedChats=this.selectedChats.filter(a=>a.id!==e.id),this.selectedChats.length===0&&(this.forwardButton.disabled=!0);const s=[...t.children].find(a=>a.getAttribute("chat-key")===e.id),n=[...i.children].find(a=>a.getAttribute("chat-key")===e.id);if(n){const a=n.querySelector("input");a&&(a.checked=!1)}s.animate({transform:["scale(1)","scale(0.5)"],opacity:["1","0"]},{...B,duration:800}),setTimeout(()=>{const a=s.animate({height:[s.offsetHeight+"px","0px"],width:[s.offsetWidth+"px","0px"],marginBottom:["16px","0px"],marginRight:["16px","0px"]},{...B,duration:800});a.onfinish=()=>{s.remove()}},400)}}class ue{constructor(e,t){this.container=e,this.options=t,this.isPlaying=!1,this.init()}init(){this.createPlayer(),this.setupEventListeners()}createPlayer(){this.video=document.createElement("video"),this.video.className="video-player",this.video.src=this.options.videoSrc;const e=document.createElement("div");e.className="controls-wrapper";const t=document.createElement("div");t.className="video-controls",this.playPauseBtn=document.createElement("button"),this.playPauseBtn.className="control-btn clickable",this.playPauseBtn.append(y("play")),this.progressContainer=document.createElement("div"),this.progressContainer.className="progress-container",this.progressBar=document.createElement("div"),this.progressBar.className="progress-bar",this.progressContainer.appendChild(this.progressBar),this.timeDisplay=document.createElement("div"),this.timeDisplay.className="time-display",this.timeDisplay.textContent="0:00",this.downloadBtn=document.createElement("button"),this.downloadBtn.className="download-btn clickable",this.downloadBtn.append(y("download")),t.appendChild(this.timeDisplay),t.appendChild(this.progressContainer),t.appendChild(this.playPauseBtn),e.append(t,this.downloadBtn),this.container.appendChild(this.video),this.container.appendChild(e)}setupEventListeners(){this.playPauseBtn.addEventListener("click",()=>this.togglePlayback()),this.progressContainer.addEventListener("click",e=>{const t=this.progressContainer.getBoundingClientRect(),i=(e.clientX-t.left)/t.width;this.video.currentTime=i*this.video.duration}),this.downloadBtn.addEventListener("click",()=>{Z(this.video.src,this.options.fileName)}),this.video.addEventListener("timeupdate",()=>this.updateProgress()),this.video.addEventListener("loadedmetadata",()=>this.updateTimeDisplay()),this.video.addEventListener("ended",()=>{this.isPlaying=!1,this.playPauseBtn.replaceChildren(y("play"))})}togglePlayback(){this.video.paused?(this.video.play(),this.isPlaying=!0,this.playPauseBtn.replaceChildren(y("pause"))):(this.video.pause(),this.isPlaying=!1,this.playPauseBtn.replaceChildren(y("play")))}formatTime(e){const t=Math.floor(e/60),i=Math.floor(e%60);return`${t}:${i<10?"0":""}${i}`}updateTimeDisplay(){this.timeDisplay.textContent=`${this.formatTime(this.video.currentTime)}`}updateProgress(){const e=this.video.currentTime/this.video.duration*100;this.progressBar.style.width=`${e}%`,this.updateTimeDisplay()}}class ge{constructor({container:e,attachmentElements:t}){this.container=e,this.attachmentElements=t,this.attachments=this.attachmentElements.map(i=>({...i.dataset,type:ae(i.dataset.url)})),this.currentCategory="image",this.categories={image:{name:"Photos & Videos",count:0},document:{name:"Documents",count:0},other:{name:"Others",count:0}},this.groupedFiles={},this.init()}init(){this.categorizeFiles(),this.groupFilesByDate(),this.render()}categorizeFiles(){this.attachments.forEach(e=>{e.type==="image"||e.type==="video"?this.categories.image.count++:e.type==="document"?this.categories.document.count++:this.categories.other.count++})}groupFilesByDate(){this.groupedFiles={image:this.groupFilesByTime(this.attachments.filter(e=>e.type==="image"||e.type==="video")),document:this.groupFilesByTime(this.attachments.filter(e=>e.type==="document")),other:this.groupFilesByTime(this.attachments.filter(e=>e.type!=="image"&&e.type!=="video"&&e.type!=="document"))}}groupFilesByTime(e){const t=new Date;t.setHours(0,0,0,0);const i=new Date(t);i.setDate(i.getDate()-1);const s=new Date(t);s.setDate(t.getDate()-(t.getDay()||7)+1);const n=new Date(s);n.setDate(s.getDate()-7);const a=new Date(t.getFullYear(),t.getMonth(),1),o=new Date(t.getFullYear(),t.getMonth()-1,1),r=new Date(t.getFullYear(),0,1),l=new Date(t.getFullYear()-1,0,1),c={};return e.forEach(p=>{const m=new Date(p.date);m.setHours(0,0,0,0);let f;m.getTime()===t.getTime()?f="Today":m.getTime()===i.getTime()?f="Yesterday":m>=s?f="This week":m>=n?f="Last week":m>=a?f="This month":m>=o?f="Last month":m>=r?f="This year":m>=l?f="Last year":f="A long time ago",c[f]||(c[f]=[]),c[f].push(p)}),c}createElement(e,t,i={}){const s=document.createElement(e);t&&(s.className=t);for(const[n,a]of Object.entries(i))s.setAttribute(n,a);return s}render(){this.viewerElement=this.createElement("div","grid-media-viewer"),this.container.appendChild(this.viewerElement);const e=this.createElement("div","viewer-header");this.viewerElement.appendChild(e);const t=this.createElement("div","viewer-title");t.innerHTML="All Media",e.appendChild(t),this.closeButton=this.createElement("button","nav-btn close-btn"),this.closeButton.appendChild(y("close")),this.closeButton.addEventListener("click",()=>this.closeViewer()),e.appendChild(this.closeButton);const i=this.createElement("div","category-tabs");this.viewerElement.appendChild(i),this.tabElements={},Object.entries(this.categories).forEach(([a,o])=>{const r=this.createElement("div",`category-tab ${this.currentCategory===a?"active":""}`);r.dataset.category=a,i.appendChild(r);const l=this.createElement("span");l.textContent=o.name,r.appendChild(l);const c=this.createElement("span","category-count");c.textContent=o.count,r.appendChild(c),r.addEventListener("click",()=>this.switchCategory(a)),this.tabElements[a]=r}),this.tabsContentContainer=this.createElement("div","tabs-content-container"),this.viewerElement.appendChild(this.tabsContentContainer),this.tabsContentWrapper=this.createElement("div","tabs-content-wrapper"),this.tabsContentContainer.appendChild(this.tabsContentWrapper);const n=Object.keys(this.categories).indexOf(this.currentCategory);this.tabsContentWrapper.style.transform=`translateX(-${n*100}%)`,Object.keys(this.categories).forEach(a=>{const o=this.createElement("div","tab-content");o.dataset.category=a,this.tabsContentWrapper.appendChild(o),this.renderContent(o,a)})}renderContent(e,t){const i=this.groupedFiles[t];["Today","Yesterday","This week","Last week","This month","Last month","This year","Last year","A long time ago"].forEach(n=>{const a=i[n];if(!a||a.length===0)return;const o=this.createElement("div","time-group");e.appendChild(o);const r=this.createElement("div","time-header");o.appendChild(r);const l=this.createElement("span");l.textContent=n,r.appendChild(l);const c=this.createElement("span","group-count");c.textContent=a.length,r.appendChild(c),t==="image"?this.renderPhotosGrid(o,a):this.renderDocumentsList(o,a)})}renderPhotosGrid(e,t){const i=this.createElement("div","media-grid");e.appendChild(i);const s=t.map(n=>{const a=this.createElement("div","media-item");if(n.type==="image"){const o=this.createElement("img","media-thumbnail",{src:n.thumbnail||n.url,alt:n.name,"data-id":n.id});o.onclick=()=>{this.goToCarouselView(o)},a.appendChild(o)}else if(n.type==="video"){const o=this.createElement("video","media-thumbnail",{src:n.thumbnail||n.url,"data-id":n.id});o.onclick=()=>{this.goToCarouselView(o)},a.appendChild(o),a.appendChild(y("play",32,"0 0 24 24"))}return a});i.replaceChildren(...s)}renderDocumentsList(e,t){const i=this.createElement("div","list-view");e.appendChild(i);const s=t.map(n=>{const a=this.createElement("div",`list-item ${n.type==="other"?"unknown-file":""}`,{"data-id":n.id}),o=this.createElement("div","doc-meta"),r=this.createElement("div","file-details"),l=n.name.split(".").pop(),c=this.createElement("p","file-extension");c.textContent=`${l}`,r.append(c,`${n.size}`);const p=y("file-fill",84,"0 0  32 32");p.classList.add("file-doc-item"),p.setAttribute("data-file-type",l),o.append(p,r),a.append(o);const m=this.createElement("div","list-info");a.appendChild(m);const f=this.createElement("div","list-name");f.textContent=n.name,m.appendChild(f);const x=this.createElement("span","file-size");x.textContent=n.size,m.appendChild(x);const v=this.createElement("span","file-date");v.textContent=n.date,m.appendChild(v);const w=this.createElement("button","download-button clickable");w.appendChild(y("download")),w.onclick=()=>{Z(n.url,n.name)},a.appendChild(w)});i.replaceChildren(...s)}switchCategory(e,t){const i=e==="video"?"image":e;if(i===this.currentCategory)return;this.tabElements[this.currentCategory].classList.remove("active"),this.tabElements[i].classList.add("active");const s=Object.keys(this.categories),n=s.indexOf(this.currentCategory),a=s.indexOf(i);this.tabsContentWrapper.style.transition="none",this.tabsContentWrapper.style.transform=`translateX(-${n*100}%)`,this.tabsContentWrapper.offsetHeight,t?this.tabsContentWrapper.style.transition="none":this.tabsContentWrapper.style.transition="transform 0.5s cubic-bezier(.48,.01,0,1)",this.tabsContentWrapper.style.transform=`translateX(-${a*100}%)`,this.currentCategory=i}closeViewer(){this.viewerElement.style.animation="none",this.viewerElement.animate([{transform:"translateY(0) scale(1)",opacity:1},{transform:"translateY(50px) scale(0.9)",opacity:0}],{duration:400,easing:"ease-in-out"}).onfinish=()=>{this.viewerElement.remove()}}goToCarouselView(e){const t=e.getBoundingClientRect(),i=e.dataset.id,s=this.container.getBoundingClientRect(),n=e.cloneNode(!0);n.classList.add("media-snapshot"),n.style.position="absolute",n.style.height=t.height+"px",n.style.width=t.width+"px",n.style.top=t.top-s.top+"px",n.style.left=t.left-s.left+"px",n.style.transform="none",this.container.appendChild(n);const a=new oe({container:this.container,attachmentElements:this.attachmentElements});a.viewerElement.style.opacity="0";const o=a.attachments.findIndex(c=>c.id===i);a.currentIndex=o,a.updateView(),this.currentIndex=this.attachmentElements.findIndex(c=>c===this.selectedAttachment);const l=a.mediaContainers[a.currentIndex].getBoundingClientRect();n.animate({top:"0px",left:"0px",width:l.width+"px",height:l.height+"px"},{fill:"forwards",duration:700,easing:"cubic-bezier(.48,.01,0,1)"}).onfinish=()=>{},a.viewerElement.animate({opacity:"1"},{fill:"forwards",duration:500,easing:"cubic-bezier(.48,.01,0,1)",delay:600}).onfinish=()=>{n.remove()},this.viewerElement.animate({opacity:"0"},{fill:"forwards",duration:500,easing:"ease-out"}).onfinish=()=>{this.viewerElement.remove()}}}class oe{constructor({container:e,attachmentElements:t,selectedAttachment:i}){this.container=e,this.attachmentElements=t,this.attachments=this.attachmentElements.map(s=>({...s.dataset,type:ae(s.dataset.url)})),this.currentIndex=0,this.viewerElement=null,this.selectedAttachment=i,this.renderWithAnimation()}renderWithAnimation(){if(this.selectedAttachment){const e=this.selectedAttachment.getBoundingClientRect(),t=this.container.getBoundingClientRect(),i=this.selectedAttachment.cloneNode(!0);i.classList.add("media-snapshot"),i.style.position="absolute",i.style.height=e.height+"px",i.style.width=e.width+"px",i.style.top=e.top-t.top+"px",i.style.left=e.left-t.left+"px",i.style.transform="none",this.container.appendChild(i),this.currentIndex=this.attachmentElements.findIndex(a=>a===this.selectedAttachment),this.render(),this.viewerElement.style.opacity="0";const n=this.mediaContainers[this.currentIndex].firstElementChild.firstElementChild.getBoundingClientRect();i.animate({top:n.top-t.top+"px",left:n.left-t.left+"px",width:n.width+"px",height:n.height+"px"},{fill:"forwards",duration:500,easing:"cubic-bezier(.48,.01,0,1)"}).onfinish=()=>{},this.viewerElement.animate({opacity:"1"},{fill:"forwards",duration:300,easing:"cubic-bezier(.48,.01,0,1)",delay:400}).onfinish=()=>{i.animate({opacity:"0"},{fill:"forwards",duration:200}).onfinish=()=>{i.remove()}}}else this.render()}createElement(e,t,i={}){const s=document.createElement(e);t&&(s.className=t);for(const[n,a]of Object.entries(i))s.setAttribute(n,a);return s}render(){this.viewerElement=this.createElement("div","carousel-media-viewer"),this.container.appendChild(this.viewerElement);const e=this.createElement("div","viewer-header");this.viewerElement.appendChild(e);const t=this.createElement("div","file-info");e.appendChild(t);const i=this.createElement("div","file-name-wrapper");this.fileNameElement=this.createElement("div","file-name"),this.fileSizeElement=this.createElement("span","file-size"),i.append(this.fileNameElement,this.fileSizeElement),t.appendChild(i);const s=this.createElement("div","file-meta");t.appendChild(s),this.fileDateElement=this.createElement("span","file-date"),s.appendChild(this.fileDateElement);const n=this.createElement("div","controls"),a=this.createElement("div","nav-controls");e.appendChild(a),this.prevButton=this.createElement("button","nav-btn"),this.prevButton.append(y("caret-left",24,"0 0 24 24")),a.appendChild(this.prevButton),this.nextButton=this.createElement("button","nav-btn"),this.nextButton.append(y("caret-right",24,"0 0 16 16")),a.appendChild(this.nextButton);const o=this.createElement("button","close-viewer-button clickable");o.append(y("close")),o.onclick=()=>{this.closeViewer()},n.append(a,o),e.append(n);const r=this.createElement("div","viewer-container");this.viewerElement.appendChild(r),this.viewerContent=this.createElement("div","viewer-content"),r.appendChild(this.viewerContent),this.mediaContainers=[];const l=this.attachments.map((v,w)=>{const E=this.createElement("div","media-container");switch(this.mediaContainers.push(E),v.type){case"image":{const k=this.createElement("div","wrapper"),P=this.createElement("div","image-controls"),$=this.createElement("button","zoom-in-btn clickable");$.appendChild(y("zoom-in",24,"0 0 32 32"));const Q=this.createElement("button","zoom-out-btn clickable");Q.appendChild(y("zoom-out",24,"0 0 32 32")),P.append($,Q);const D=this.createElement("img","zoomable-image",{src:v.url,alt:v.name,"data-id":v.id,loading:"lazy",draggable:!1});let b=1,T=!1,Y=0,j=0,F=0,R=0;const z=(u=!1)=>{u&&(D.style.transition="transform 0.25s cubic-bezier(.48,.01,0,1)",D.addEventListener("transitionend",function A(){D.style.transition="",D.removeEventListener("transitionend",A)})),D.style.transform=`scale(${b}) translate(${F}px, ${R}px)`},O=u=>Math.max(1,Math.min(u,5));$.onclick=()=>{const u=b;b=O(b*1.2),b!==u&&z(!0)},Q.onclick=()=>{const u=b;b=O(b/1.2),b!==u&&(b===1&&(F=0,R=0),z(!0))},k.addEventListener("wheel",u=>{if(u.ctrlKey||u.metaKey||u.altKey||u.shiftKey)return;u.preventDefault();let A=u.deltaY||u.detail||u.wheelDelta,q=b;u.ctrlKey||u.metaKey?b=O(b-A*.01):b=O(b-A*.002),b!==q&&z(!0)},{passive:!1});let _=null;k.addEventListener("touchstart",u=>{u.touches.length===2&&(_=Math.hypot(u.touches[0].clientX-u.touches[1].clientX,u.touches[0].clientY-u.touches[1].clientY))}),k.addEventListener("touchmove",u=>{if(u.touches.length===2&&_!==null){const A=Math.hypot(u.touches[0].clientX-u.touches[1].clientX,u.touches[0].clientY-u.touches[1].clientY),q=A-_;let re=b;b=O(b+q*.01),b!==re&&z(!0),_=A,u.preventDefault()}},{passive:!1}),k.addEventListener("touchend",u=>{u.touches.length<2&&(_=null)}),D.addEventListener("mousedown",u=>{b!==1&&(T=!0,Y=u.clientX-F,j=u.clientY-R,D.style.cursor="grabbing",u.preventDefault())}),document.addEventListener("mousemove",u=>{T&&(F=u.clientX-Y,R=u.clientY-j,z())}),document.addEventListener("mouseup",()=>{T&&(T=!1,D.style.cursor=b>1?"grab":"")});let X=null;D.addEventListener("touchstart",u=>{b===1||u.touches.length!==1||(X=u.touches[0].identifier,T=!0,Y=u.touches[0].clientX-F,j=u.touches[0].clientY-R,D.style.cursor="grabbing")}),D.addEventListener("touchmove",u=>{if(!T||X===null)return;const A=Array.from(u.touches).find(q=>q.identifier===X);A&&(F=A.clientX-Y,R=A.clientY-j,z(),u.preventDefault())},{passive:!1}),D.addEventListener("touchend",u=>{T&&(T=!1,X=null,D.style.cursor=b>1?"grab":"")});const ee=()=>{b=1,F=0,R=0,z(!0)};D.addEventListener("load",ee),D.resetTransform=ee,D.style.cursor="";const te=this.createElement("div","download-button-wrapper"),G=this.createElement("button","download-button clickable");G.textContent="Download",te.append(G),G.onclick=()=>{Z(v.url,v.name)},k.append(D,P,te),E.appendChild(k)}break;case"video":{const k=this.createElement("div","wrapper");new ue(k,{videoSrc:v.url,fileName:v.name}).video.setAttribute("data-id",v.id),E.appendChild(k)}break;case"document":const I=this.createElement("div","document-preview");E.appendChild(I);const L=this.createElement("div","doc-meta"),M=this.createElement("div","file-details"),S=v.name.split(".").pop(),W=this.createElement("p","file-extension");W.textContent=`${S}`,M.append(W,`${v.size}`);const U=y("file-fill",84,"0 0  32 32");U.classList.add("file-doc-item"),U.setAttribute("data-file-type",S),L.append(U,M);const V=this.createElement("button","download-button clickable");V.textContent="Download",I.append(L,V);break}return E});this.viewerContent.replaceChildren(...l);const c=this.createElement("div","thumbnails-container");this.viewerElement.appendChild(c);const p=this.createElement("div","thumbnails-wrapper");c.appendChild(p),this.thumbnailsElement=this.createElement("div","thumbnails"),p.appendChild(this.thumbnailsElement),this.thumbnails=[];const m=this.attachments.map((v,w)=>{const E=this.createElement("div",`thumbnail clickable ${v.type==="video"?"thumbnail-video":v.type==="document"?"thumbnail-document":""}`);if(this.thumbnails.push(E),v.type==="document"){const I=y("file-fill",32);I.classList.add("file-doc-item"),I.setAttribute("data-file-type",v.name.split(".").pop()),E.appendChild(I)}else if(v.type==="image"){const I=this.createElement("img","",{src:v.thumbnail||v.url,alt:v.name});E.appendChild(I)}else if(v.type==="video"){const I=this.createElement("video","",{src:v.thumbnail||v.url});E.append(I,y("play"))}return E.addEventListener("click",()=>this.goToIndex(w)),E});this.thumbnailsElement.replaceChildren(...m),this.selectionIndicator=this.createElement("div","selection-indicator"),this.thumbnailsElement.appendChild(this.selectionIndicator);const f=this.createElement("div","divider"),x=this.createElement("button","grid-view-button clickable");x.innerText="All Media",x.appendChild(y("grid-four",16)),x.onclick=()=>{this.moveToGridDisplay()},c.append(f,x),this.updateView(),this.prevButton.addEventListener("click",()=>this.navigate(-1)),this.nextButton.addEventListener("click",()=>this.navigate(1)),document.addEventListener("keydown",v=>{v.key==="ArrowLeft"?this.navigate(-1):v.key==="ArrowRight"&&this.navigate(1)})}navigate(e){const t=this.currentIndex+e;if(t>=0&&t<this.attachments.length){const i=this.attachments[this.currentIndex],s=this.currentIndex;Promise.resolve().then(()=>{if(i.type==="image"){const a=this.mediaContainers[s].querySelector(".zoomable-image");a&&typeof a.resetTransform=="function"&&a.resetTransform()}}),this.currentIndex=t,this.updateView()}}goToIndex(e){if(e>=0&&e<this.attachments.length&&e!==this.currentIndex){const t=this.attachments[this.currentIndex],i=this.currentIndex;Promise.resolve().then(()=>{if(t.type==="image"){const n=this.mediaContainers[i].querySelector(".zoomable-image");n&&typeof n.resetTransform=="function"&&n.resetTransform()}}),this.currentIndex=e,this.updateView()}}updateView(){this.viewerContent.style.transform=`translateX(-${this.currentIndex*100}%)`;const e=this.attachments[this.currentIndex];this.fileNameElement.textContent=e.name,this.fileSizeElement.textContent=`[${e.size}]`,this.fileDateElement.textContent=`Date: ${e.date}`,this.updateSelectionIndicator()}updateSelectionIndicator(){const e=this.thumbnails[this.currentIndex];if(e){const t=e.getBoundingClientRect(),i=this.thumbnailsElement.getBoundingClientRect();this.selectionIndicator.style.width=`${e.offsetWidth}px`,this.selectionIndicator.style.height=`${e.offsetHeight}px`,this.selectionIndicator.style.left=`${t.left-i.left}px`;const s=this.thumbnailsElement.parentElement,n=e.offsetLeft+e.offsetWidth/2,a=s.offsetWidth,o=Math.max(0,n-a/2);s.scrollTo({left:o,behavior:"smooth"})}}closeViewer(){const e=this.attachmentElements[this.currentIndex],t=e.closest(".file-list"),i=e.closest(".messages-container"),s=e.getBoundingClientRect(),n=t.getBoundingClientRect(),a=i.getBoundingClientRect(),o=s.left>=n.left&&s.right<=n.right,r=s.left>=a.left&&s.right<=a.right;if(o&&r){const l=this.mediaContainers[this.currentIndex].firstElementChild.firstElementChild,c=this.container.getBoundingClientRect(),p=l.getBoundingClientRect(),m=l.cloneNode(!0);m.classList.add("media-snapshot"),m.style.position="absolute",m.style.height=p.height+"px",m.style.width=p.width+"px",m.style.top=p.top-c.top+"px",m.style.left=p.left-c.left+"px",m.style.transform="none",this.container.appendChild(m),l.style.opacity="0";const f=e.getBoundingClientRect();m.animate({top:f.top-c.top+"px",left:f.left-c.left+"px",width:f.width+"px",height:f.height+"px",borderRadius:"8px"},{fill:"forwards",duration:500,easing:"cubic-bezier(.48,.01,0,1)"}).onfinish=()=>{m.remove()},this.viewerElement.animate({opacity:"0"},{easing:"ease-out",fill:"forwards",duration:300}).onfinish=()=>{this.viewerElement.remove()}}else this.viewerElement.animate({transform:"scale(0.95)",opacity:0},{fill:"forwards",duration:200,easing:"ease-out"}).onfinish=()=>{this.viewerElement.remove()}}moveToGridDisplay(){const e=this.mediaContainers[this.currentIndex].firstElementChild.firstElementChild,t=this.attachments[this.currentIndex],i=e.getBoundingClientRect(),s=new ge({container:this.container,attachmentElements:this.attachmentElements});this.viewerElement.animate({transform:"scale(0.95)",opacity:0},{fill:"forwards",duration:200,easing:"ease-out"}).onfinish=()=>{this.viewerElement.remove()},s.viewerElement.style.opacity="0",s.switchCategory(t.type,!0);const n=s.viewerElement.querySelector(`[data-id='${t.id}']`),a=n.closest(".tab-content");a.scrollTo(0,n.offsetTop-a.offsetHeight/2);const o=n.getBoundingClientRect(),r=this.container.getBoundingClientRect(),l=e.cloneNode(!0);l.classList.add("media-snapshot"),l.style.position="absolute",l.style.height=i.height+"px",l.style.width=i.width+"px",l.style.top=i.top-r.top+"px",l.style.left=i.left-r.left+"px",l.style.transform="none",this.container.appendChild(l),l.animate({top:o.top-r.top+"px",left:o.left-r.left+"px",...["document","other"].includes(t.type)?{}:{width:o.width+"px"},height:o.height+"px"},{fill:"forwards",duration:500,easing:"cubic-bezier(.48,.01,0,1)"}).onfinish=()=>{l.remove()},this.viewerElement.animate({opacity:"1"},{fill:"forwards",duration:500,easing:"cubic-bezier(.48,.01,0,1)",delay:175}),s.viewerElement.animate({opacity:"1"},{fill:"forwards",duration:500,easing:"cubic-bezier(.48,.01,0,1)",delay:175})}}const fe={delivered_all:"delivered_all"},se=new Intl.DateTimeFormat("en-us",{timeStyle:"short"});class K{constructor({id:e,text:t,files:i,isSent:s,receivedFiles:n,time:a,reply:o,replyMessage:r,senderId:l,messageElement:c,chat:p,dropDownWrapper:m,isAdmin:f}){h(this,"id");h(this,"text");h(this,"files");h(this,"message");h(this,"timeElement");h(this,"footerElement");h(this,"isSent");h(this,"receivedFiles");h(this,"reply",null);h(this,"replyMessage");h(this,"time");h(this,"senderId");h(this,"messageElement");h(this,"chat");h(this,"featureListDropDown");h(this,"isAnimating",!1);h(this,"isDeleted",!1);h(this,"isAdmin");this.initFileWrapper=this.initFileWrapper.bind(this),this.id=e||N(10),this.text=t,this.files=i,this.isSent=s,this.receivedFiles=n,this.time=a,this.reply=o,this.replyMessage=r,this.senderId=l,this.messageElement=c,this.chat=p,this.isAdmin=f,this.init(),this.uploadFiles=this.uploadFiles.bind(this),this.updateMessageId=this.updateMessageId.bind(this),this.markAsDelivered=this.markAsDelivered.bind(this),this.markAsRead=this.markAsRead.bind(this),this.markAsSending=this.markAsSending.bind(this),this.markAsSent=this.markAsSent.bind(this)}init(){this.messageElement?this.initExistingMessage():(this.initMessage(),this.initMessageFooter(),this.handleReceivedFiles(),this.initMessageStatus(),this.handleReplyMessage()),this.handleReply(),this.hanleMessageReply(),this.initDropDownFeatures(),this.internalEventsListers(),this.message.message=this}initMessage(){const e=d("pre","",this.text);this.message=d("div","message"),this.message.setAttribute("data-type",this.isSent?"sent":"received"),this.message.setAttribute("data-sender-id",this.senderId),this.message.setAttribute("data-id",this.id),this.message.setAttribute("data-time",this.time),this.message.append(e)}initExistingMessage(){var e;this.text=(e=this.messageElement.querySelector("pre"))==null?void 0:e.textContent,this.isSent=this.messageElement.dataset.type==="sent",this.time=this.messageElement.dataset.time,this.senderId=this.messageElement.dataset.senderId,this.message=this.messageElement,this.footerElement=this.messageElement.querySelector("footer"),this.id=this.messageElement.getAttribute("data-id"),this.isDeleted=this.messageElement.dataset.isDeleted==="true",this.messageElement.querySelectorAll(".file-wrapper").forEach(this.initFileWrapper),delete this.messageElement}initMessageFooter(){this.footerElement=d("footer"),this.timeElement=d("div","time",this.time?se.format(new Date(this.time)):""),this.footerElement.append(this.timeElement),this.message.append(this.footerElement)}initMessageStatus(){if(this.isSent){const e=d("div","status"),t=y("clock",12);t.classList.add("sending");const i=y("check-2",12);i.classList.add("sent");const s=y("checks",12);s.classList.add("delivered"),this.footerElement.append(e),e.append(t,i,s),this.message.setAttribute("data-status","sending"),this.message.markAsSending=this.markAsSending,this.message.markAsSent=this.markAsSent,this.message.markAsDelivered=this.markAsDelivered,this.message.markAsRead=this.markAsRead}}handleReceivedFiles(){if(this.receivedFiles&&this.receivedFiles.length>0){const e=d("div","file-list");this.receivedFiles.forEach(t=>{const i=d("div","file-wrapper");if(["jpeg","png","jpg","webp"].includes(t.name.split(".").pop())){const s=d("img",void 0,void 0,{src:t.remoteURL,alt:t.name});i.appendChild(s)}else{const s=y("file-fill",84,"0 0 32 32"),n=t.name.split(".").pop(),a=d("div","file-details"),o=d("p","file-extension",n),r=Chat.getFileSize(t.size);s.classList.add("file-doc-item"),s.setAttribute("data-file-type",n),a.append(o,r),i.append(s,a)}e.appendChild(i),this.initFileWrapper(i)}),this.message.prepend(e)}}handleReplyMessage(){if(this.replyMessage){const{replyWrapper:e,messageId:t}=this.chat.createReplyMessage(this.replyMessage,!1);this.message.prepend(e),e.onclick=()=>{const i=document.querySelector(`[data-id="${t}"]`);i.scrollIntoView({behavior:"smooth"}),i.animate({transform:"scale(1.1)"},{delay:200,iterations:4,duration:400,easing:"ease-out",direction:"alternate"})}}}handleReply(){if(this.reply){const e=this.reply.user_id===this.chat.userId,t=d("div",`reply-wrapper ${e?"sent":"received"}`),i=d("div","reply-container"),s=d("p","user",e?"You":this.reply.name),n=d("p","reply-message",this.reply.message),a=d("div","content-wrapper");if(a.append(s,n),i.append(a),this.reply.image){const o=d("img","reply-image",void 0,{src:this.reply.image});i.appendChild(o)}t.appendChild(i),this.message.prepend(t)}}async uploadFiles(){const e=this;return new Promise((t,i)=>{const s=[];if(e.files.length>0){const n=o=>{s.push(o),s.length===e.files.length&&t(s)},a=d("div","file-list");this.files.forEach(o=>{const r=o.file.type.split("/").shift(),l=d("div","file-wrapper");if(r==="image"){const c=d("img",void 0,void 0,{src:URL.createObjectURL(o.file),alt:o.file.name});l.appendChild(c),new J({file:o,container:l,onUploadComplete:n})}else if(r==="video"){const c=d("video","","");c.autoplay=!1,c.controls=!1,c.loop=!1,c.src=URL.createObjectURL(o.file),l.appendChild(c),new J({file:o,container:l,onUploadComplete:n})}else{const c=y("file-fill",84,"0 0 32 32"),p=o.file.name.split(".").pop(),m=d("div","file-details"),f=d("p","file-extension",p),x=Chat.getFileSize(o.file);c.classList.add("file-doc-item"),c.setAttribute("data-file-type",p),m.append(f,x),l.append(c,m),new J({file:o,container:l,idleElement:m,onUploadComplete:n})}a.appendChild(l)}),e.message.prepend(a)}else t(s)})}updateMessageId(e){this.id=e,this.message.setAttribute("data-id",e)}updateMessageText(e){this.message.querySelector("pre").textContent=e,this.text=e}markAsSending(){this.message.setAttribute("data-status","sending")}markAsSent(e){this.message.setAttribute("data-status","sent"),this.message.setAttribute("data-time",e),this.timeElement.innerHTML=se.format(new Date(e))}markAsDelivered(){var e;(e=this==null?void 0:this.message)==null||e.setAttribute("data-status","delivered")}markAsRead(){this.message.setAttribute("data-status","read")}hanleMessageReply(){this.message.addEventListener("dblclick",()=>{this.isDeleted||this.chat.appendReplyMessage(this.message)})}initDropDownFeatures(){this.isDeleted||(this.dropDownContainer=d("div","drop-down-container"),this.dropDownButton=this.createMessageDropDownButton(),this.createDropDownWrapper(),this.dropDownContainer.append(this.dropDownButton),this.message.appendChild(this.dropDownContainer))}createMessageDropDownButton(){const e=d("button","drop-down-button"),t=y("caret-down",24,"0 0 16 16");return this.isDropDownOpen=!1,e.onclick=()=>{this.isAnimating||(this.isDropDownOpen?this.closeDropDown():this.openDropDown())},e.appendChild(t),e}createDropDownWrapper(){this.dropDownWrapper=d("div","drop-down-wrapper"),this.createFeatureListDropDown(),this.dropDownWrapper.appendChild(this.featureListDropDown)}createFeatureListDropDown(){this.featureListDropDown=d("div","feature-list-drop-down");const e=d("ul","feature-list");[{text:"Reply",action:()=>{this.closeDropDown(),this.chat.appendReplyMessage(this.message)}},...this.isAdmin?[{text:"Forward",action:()=>{this.closeDropDown(),this.forwardMessage()}}]:[],{secure:!0,text:"Edit",action:()=>{this.closeDropDown(),this.editMessage()}},{secure:!0,text:"Delete",action:()=>{this.closeDropDown(),this.chat.deleteMessage(this.id)}}].forEach(i=>{let s=d("button","feature",i.text);if(s.addEventListener("click",()=>{i.action()}),i.secure&&this.senderId!==this.chat.userId){s=null;return}e.appendChild(s)}),this.featureListDropDown.appendChild(e)}openDropDown(){var i;if(this.isDeleted)return;this.isDropDownOpen=!0,(i=this.exitingAnimation)==null||i.cancel(),this.dropDownWrapper.style.top="calc(100% + 12px)",this.dropDownWrapper.style.bottom="auto",this.dropDownWrapper.style.transformOrigin="top right",this.dropDownWrapper.style.transform="scale(1)";const e=this.message.parentElement.getBoundingClientRect();this.dropDownContainer.appendChild(this.dropDownWrapper);const t=this.dropDownWrapper.getBoundingClientRect();this.dropDownWrapper.style.transform="scale(0.5)",this.dropDownWrapper.style.opacity="0",t.bottom>e.bottom&&(this.dropDownWrapper.style.top="auto",this.dropDownWrapper.style.bottom="calc(100% + 12px)",this.dropDownWrapper.style.transformOrigin="bottom right"),t.left<20&&(this.dropDownWrapper.style.left="0px",this.dropDownWrapper.style.width="fit-content",this.dropDownWrapper.style.transformOrigin="bottom left"),this.isAnimating=!0,this.enteringAnimation=this.dropDownWrapper.animate({transform:"scale(1)",opacity:"1"},{...B,duration:500}),this.enteringAnimation.onfinish=()=>{this.isAnimating=!1,this.enteringAnimation.commitStyles(),this.enteringAnimation.cancel()},setTimeout(()=>{window.addEventListener("click",this.handleOnClickClose)},200)}handleOnClickClose(e){ie(".drop-down-wrapper").forEach(i=>{var n,a;const s=i.closest(".message");s.contains(e.target)||(a=(n=s==null?void 0:s.message)==null?void 0:n.closeDropDown)==null||a.call(n)})}closeDropDown(){var e;window.removeEventListener("click",this.handleOnClickClose),this.isDropDownOpen=!1,(e=this.enteringAnimation)==null||e.cancel(),this.exitingAnimation=null,this.isAnimating=!0,this.exitingAnimation=this.dropDownWrapper.animate({transform:["scale(1)","scale(0.5)"],opacity:["1","0"]},{...B,duration:500}),this.exitingAnimation.onfinish=()=>{this.isAnimating=!1,this.dropDownContainer.removeChild(this.dropDownWrapper)}}forwardMessage(){isAdmin&&new me({chat:this.chat,message:this.message})}editMessage(){this.chat.editMessage(this.message)}deleteMessage(){const e=y("block",32),t=d("span","deleted-message",this.senderId===this.chat.userId?"You deleted This Message":"This message was deleted"),i=d("div","deleted-message-wrapper");i.append(e,t),this.message.replaceChildren(i),this.isDeleted=!0}internalEventsListers(){window.addEventListener(fe.delivered_all,()=>{var e;((e=this==null?void 0:this.message)==null?void 0:e.getAttribute("data-status"))==="sent"&&this.markAsDelivered()})}initFileWrapper(e){e.onclick=()=>{new oe({container:H(".chat-app"),attachmentElements:[...ie(".file-wrapper",this.message.parentElement)],selectedAttachment:e})}}}class ye{constructor({maxFileSize:e,files:t,sendMessage:i,conversation:s,chatApp:n,typingIndicator:a,container:o,websocket:r,syncDatePills:l}){h(this,"footer");h(this,"AnimationConfig",{duration:1200,fill:"forwards",easing:"cubic-bezier(.48,.01,0,1)"});this.maxFileSize=e,this.files=t,this.sendMessage=i,this.conversation=s,this.chatApp=n,this.typingIndicator=a,this.container=o,this.websocket=r,this.syncDatePills=l,this.initMessageInput=this.initMessageInput.bind(this),this.createFooter(),this.initSendButton(),this.initMessageInput()}createFooter(){this.footer=g("footer"),this.attachmentWrapper=g("div","attachment-wrapper");const e=g("button","attach clickable"),t=y("attachment",24,"0 0 20 20");e.appendChild(t);const i=g("div","attachment-popup"),s=g("p","max-file-size-text",`Max File Size: ${this.maxFileSize||"100MB"}`),n=g("label","clickable"),a=y("image-2",24,"0 0 20 20");n.appendChild(a);const o=g("input",void 0,void 0,{type:"file",accept:"image/*,video/*",multiple:""});o.onchange=w=>{const E=[...w.target.files],I=parseInt(this.maxFileSize)*1024*1024,{valid:L,tooBig:M,wrongType:S}=this.filterFiles(E,{maxSize:I,mustBeImage:!0});this.showErrors(M.length,S.length,"media"),this.addMedia(L),i.classList.remove("open"),o.value=""},n.appendChild(o);const r=g("label","clickable"),l=y("file",24,"0 0 32 32");r.appendChild(l);const c=g("input",void 0,void 0,{type:"file",multiple:"",accept:".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt,.zip,.rar,.7z,.csv,.json,.js,.html,.css,.py"});c.onchange=w=>{const E=[...w.target.files],I=parseInt(this.maxFileSize)*1024*1024,L=this.getAcceptedExtensions(c),M=E.filter(W=>W.size<=I&&this.isAcceptedFile(W,L)),S=E.length-M.length;S===1?error("1 file was invalid or too large and was removed."):S>1&&error(`${S} files were invalid or too large and were removed.`),this.addDocument(M),i.classList.remove("open"),c.value=""},r.appendChild(c);const p=g("div","message-input-wrapper"),m=g("div","message-input",void 0,{contenteditable:"plaintext-only","data-placeholder":"Type your message"});this.footer.addEventListener("click",w=>{w.target===this.footer&&this.messageInput.focus()}),p.appendChild(m),this.messageInputWrapper=p,this.messageInput=m;const f=g("button","clickable send-message"),x=y("paper-plane-tilt",16,"0 0 25 24");f.appendChild(x),this.sendButton=f,e.onclick=()=>{i.classList.toggle("open")},window.addEventListener("click",w=>{this.attachmentWrapper.contains(w.target)||i.classList.remove("open")}),window.addEventListener("keydown",w=>{w.key==="Escape"&&i.classList.remove("open")});const v=g("div","labels-wrapper");return v.append(n,r),i.append(s,v),this.attachmentWrapper.append(e,i),this.footer.append(this.attachmentWrapper,p,f),this.container.appendChild(this.footer),this.defaultFooterHeight=this.footer.offsetHeight,this.defaultEditableHeight=this.messageInput.offsetHeight,this.footer}filterFiles(e,{maxSize:t,mustBeImage:i}){const s=e.filter(o=>o.size>t),n=e.filter(o=>i?!o.type.includes("image")&&!o.type.includes("video"):o.type.includes("image")&&o.type.includes("video"));return{valid:e.filter(o=>o.size<=t&&(i?o.type.includes("image")||o.type.includes("video"):!o.type.includes("image")||!o.type.includes("video"))),tooBig:s,wrongType:n}}showErrors(e,t,i){e===1?error("1 file was too large and was removed."):e>1&&error(`${e} files were too large and were removed.`,5e3),t===1?error(`1 file was not a valid ${i} and was removed.`,5e3):t>1&&error(`${t} files were not valid ${i}s and were removed.`,5e3)}getAcceptedExtensions(e){return e.getAttribute("accept").split(",").map(t=>t.trim().toLowerCase())}isAcceptedFile(e,t){return t.some(i=>e.name.toLowerCase().endsWith(i))}addMedia(e){[...e].forEach(t=>{const i=N(4);this.files.current.push({id:i,file:t}),this.appendMediaFileToFileList(t,i)})}addDocument(e){[...e].forEach(t=>{const i=N(4);this.files.current.push({id:i,file:t}),this.appendDocFileToFileList(t,i)})}appendMediaFileToFileList(e,t){const i=e.type.split("/").shift(),s=g("div","attached-file"),n=g("button","remove-file clickable",void 0,{type:"button"});n.onclick=()=>{this.removeFileFromList(s,t)};const a=y("close",8,"0 0 24 24"),o=URL.createObjectURL(e);if(n.appendChild(a),i==="image"){const l=g("img",void 0,void 0,{src:o,alt:e.name});s.append(l)}else if(i==="video"){const l=g("video","","");l.autoplay=!1,l.controls=!1,l.loop=!1,l.src=o,s.append(l)}s.append(n);let r=this.messageInputWrapper.querySelector(".file-list");r||(r=g("div","file-list"),this.messageInputWrapper.prepend(r)),s.style.height="0px",s.style.opacity="0",s.style.transform="scale(0.5)",s.style.marginBottom="0px",r.appendChild(s),s.animate({height:s.scrollHeight+"px",marginBottom:"8px"},this.AnimationConfig),s.animate({transform:"scale(1)",opacity:"1"},{...this.AnimationConfig,delay:300})}appendDocFileToFileList(e,t){const i=g("div","attached-file"),s=y("file-fill",84,"0 0 32 32"),n=e.name.split(".").pop(),a=g("div","file-details"),o=g("p","file-extension",n),r=he(e);s.classList.add("file-doc-item"),s.setAttribute("data-file-type",n),a.append(o,r);const l=g("button","remove-file clickable",void 0,{type:"button"});l.onclick=()=>{this.removeFileFromList(i,t)};const c=y("close",8,"0 0 24 24");l.appendChild(c),i.append(s,a,l);let p=this.messageInputWrapper.querySelector(".file-list");p||(p=g("div","file-list"),this.messageInputWrapper.prepend(p)),i.style.height="0px",i.style.opacity="0",i.style.transform="scale(0.5)",i.style.marginBottom="0px",p.appendChild(i),i.animate({height:i.scrollHeight+"px",marginBottom:"8px"},this.AnimationConfig),i.animate({transform:"scale(1)",opacity:"1"},{...this.AnimationConfig,delay:300})}removeFileFromList(e,t){e.animate({transform:["scale(1)","scale(0.5)"],opacity:["1","0"]},this.AnimationConfig),setTimeout(()=>{const i=e.animate({height:"0px",width:"0px",marginBottom:"0px",marginRight:"0px"},this.AnimationConfig);i.onfinish=()=>{e.remove()}},300),this.files.current=this.files.current.filter(i=>i.id!==t)}initMessageInput(){let e=!1,t=null;this.defaultEditableHeight=this.messageInput.offsetHeight,this.messageInput.addEventListener("input",i=>{this.messageInput.textContent.trim()===""&&this.messageInput.replaceChildren(),e||(this.sendMessage({conversation_id:this.conversationId,sender_id:this.userId,type:"active-typing"}),e=!0),clearTimeout(t),t=setTimeout(()=>{this.sendMessage({conversation_id:this.conversationId,sender_id:this.userId,type:"idle-typing"}),e=!1},2e3)}),this.messageInput.addEventListener("keydown",i=>{i.key==="Enter"&&!i.shiftKey&&(i.preventDefault(),this.prepareMessageForSend())}),this.messageInput.addEventListener("focus",()=>{this.sendMessage({conversation_id:this.conversationId,sender_id:this.userId,type:"focus"})}),this.messageInput.addEventListener("blur",()=>{this.sendMessage({conversation_id:this.conversationId,sender_id:this.userId,type:"blur"})}),this.messageInput.onpaste=function(i){var s=(i.clipboardData||window.clipboardData).getData("text");if(/<([^]+)([\s]+)([^]+)(?:(>|<))/.exec(s)!==null)return i.preventDefault(),alert("This is HTML"),!1}}initSendButton(){this.sendButton.onclick=()=>{this.prepareMessageForSend()}}async prepareMessageForSend(){this.messageInput.textContent.trim()===""&&this.files.current.length==0||(this.messageInput.textContent.trim()===""&&this.messageInput.remove(),this.messageInput.blur(),this.messageToEdit?this.sendEditedChatMessage():this.sendNewChatMessage())}async sendNewChatMessage(){var l,c;const e=this.messageInput.textContent,{uploadFiles:t,markAsSent:i,updateMessageId:s}=this.appendSentMessage();let n=null;this.replyMessage&&(n={id:this.replyMessage.dataset.id,name:this.receipient.name,user_id:this.replyMessage.dataset.senderId,message:(l=this.replyMessage.querySelector("pre"))==null?void 0:l.textContent,image:(c=this.replyMessage.querySelector("img"))==null?void 0:c.src},this.replyMessage=null);const a=await t(),o=N(10),r={message_id:o,conversation_id:this.conversationId,message:e,sender_id:this.userId,type:"send_message",time:new Date().toJSON(),...a.length>0&&{sentFiles:a},reply:n};if(s(o),this.websocket.readyState===WebSocket.OPEN){this.sendMessage(r),i(r.time);const p=this.chatSelectsMap[this.conversationId];p&&(p.querySelector("p").innerText=e)}}sendEditedChatMessage(){const e={message_id:this.messageToEdit.message.id,conversation_id:this.conversationId,message:this.messageInput.textContent,sender_id:this.userId,type:"edit_message"};this.websocket.readyState===WebSocket.OPEN&&(this.sendMessage(e),this.removeEditMode())}appendSentMessage(){this.conversation.scrollTo(0,0),this.messageInput.spellcheck=!1;const e=this.messageInputWrapper.getBoundingClientRect(),t=this.conversation.firstElementChild.getBoundingClientRect(),i=this.chatApp.getBoundingClientRect();let a=e.height+14+32;const o=g("div");o.style.height="0px",o.style.flex="none",o.style.alignSelf="flex-end";const r=this.conversation.firstElementChild;this.typingIndicator.isTyping?this.typingIndicator.typingIndicatorWrapper.insertAdjacentElement("afterEnd",o):r.prepend(o),t.height+r.top-a;const l=o.getBoundingClientRect();this.messageInputWrapper.style.top=e.top+"px",this.messageInputWrapper.style.height=e.height+"px",this.messageInputWrapper.style.width=e.width+"px",this.messageInputWrapper.style.right=e.right+"px",this.messageInputWrapper.style.position="fixed",this.messageInputWrapper.style.boxSizing="content-box",this.messageInputWrapper.style.right=window.innerWidth-e.right+"px",this.messageInputWrapper.style.top=e.top+"px",this.messageInputWrapper.style.marginBottom="14px",this.messageInputWrapper.style.backgroundColor="transparent",this.messageInputWrapper.blur();const c=g("div","message-input-wrapper"),p=g("div","message-input",void 0,{contentEditable:"plaintext-only","data-placeholder":"Type your message"});c.appendChild(p),c.style.height=e.height+"px",c.style.opacity="0",c.style.transition="opacity 1s ease-out",p.setAttribute("role","textbox"),this.messageInputWrapper.insertAdjacentElement("afterend",c),setTimeout(()=>{c.style.opacity="1"},400),o.animate({height:["0px",a+"px"]},{duration:800,easing:"cubic-bezier(.17,.67,.16,.99)",fill:"forwards"});const m=this.messageInputWrapper.animate({top:[e.top-i.top+"px",t.bottom-i.top-12-a+(this.footer.offsetHeight-this.defaultFooterHeight)-(this.typingIndicator.isTyping?this.typingIndicator.typingIndicatorWrapper.offsetHeight:0)+"px"],right:[i.right-e.right+"px",i.right-l.right+"px"],paddingLeft:["0px","8px"],paddingRight:["0px","8px"],paddingTop:["0px","8px"],paddingBottom:["0px","24px"],borderRadius:["0px 0px 0px 0px","10px 0px 10px 10px"],backgroundColor:["transparent","rgba(0, 122, 255, 0.15)"]},{duration:800,easing:"cubic-bezier(.17,.67,.16,.99)",fill:"forwards"}),f=c.animate({height:[e.height+"px",this.defaultEditableHeight+"px"]},{duration:600,easing:"cubic-bezier(.17,.67,.16,.99)",fill:"forwards"}),x=new K({text:this.messageInput.textContent,files:this.files.current,senderId:this.userId,isSent:!0,chat:this,replyMessage:this.replyMessage,isAdmin:this.isAdmin}),{message:v}=x;return this.files.current=[],f.onfinish=()=>{f.cancel(),c.style.height="auto"},this.messageInput=p,this.messageInput.focus(),m.onfinish=()=>{o.replaceWith(v),this.messageInputWrapper.remove(),this.messageInputWrapper=c,this.initMessageInput(),this.sendMessage({conversation_id:this.conversationId,sender_id:this.userId,type:"focus"}),this.syncDatePills()},x}}class ne{constructor({container:e,messages:t}){h(this,"searchResults",[]);h(this,"lastLookuop",null);this.container=e,this.messages=[...t],this.handleEscapePress=this.handleEscapePress.bind(this),this.init()}init(){this.createView(),this.insertViewToContainer(),this.initEscapeKeyListener()}createView(){this.createContainer(),this.createSearchView(),this.createSearchResultsLookup(),this.createCloseSearchButton()}createContainer(){this.chatSearchContainer=d("div","chat-search-container"),this.chatSearchContentContainer=d("div","chat-search-content-container"),this.chatSearchContainer.appendChild(this.chatSearchContentContainer)}createSearchView(){this.searchQueryWrapper=d("div","search-query-wrapper"),this.searchQueryInput=d("input","search-query-input","",{placeholder:"Search..."}),this.searchResultsView=d("div","search-results"),this.searchQueryInput.oninput=()=>{this.onSearchInput()},this.searchQueryWrapper.append(this.searchQueryInput,this.searchResultsView),this.chatSearchContentContainer.appendChild(this.searchQueryWrapper)}createSearchResultsLookup(){const e=d("div","search-results-lookup");this.moveUpButton=d("button","clickable","",{disabled:"true"}),this.moveUpButton.appendChild(y("arrow-caret-up")),this.moveUpButton.onclick=()=>{this.goToSearchResult(this.lookUpIndex+1)},this.moveDownButton=d("button","clickable","",{disabled:"true"}),this.moveDownButton.onclick=()=>{this.goToSearchResult(this.lookUpIndex-1)},this.moveDownButton.appendChild(y("arrow-caret-down")),e.append(this.moveUpButton,this.moveDownButton),this.chatSearchContentContainer.appendChild(e)}createCloseSearchButton(){this.closeSearchButton=d("button","close-search-button clickable"),this.closeSearchButton.appendChild(y("close",24)),this.closeSearchButton.onclick=()=>{this.closeSearch()},this.chatSearchContentContainer.appendChild(this.closeSearchButton)}insertViewToContainer(){this.chatSearchContainer.style.height="0px",this.chatSearchContainer.style.opacity="0",this.chatSearchContainer.style.transform="scale(0.9)",this.container.append(this.chatSearchContainer),this.chatSearchContainer.animate({height:["0px",this.chatSearchContainer.scrollHeight+"px"]},B),this.chatSearchContainer.animate({opacity:["0","1"],transform:["scale(0.7)","scale(1)"]},{...B,delay:300}),this.searchQueryInput.focus()}async removeView(){this.chatSearchContainer.animate({height:[this.chatSearchContainer.offsetHeight+"px","0px"]},{...B,delay:300}),await this.chatSearchContainer.animate({opacity:["1","0"],transform:["scale(1)","scale(0.7)"]},B).finished}resetState(){var e;this.container=null,this.messages=[],this.searchResults=[],this.lookUpIndex=0,(e=this.chatSearchContainer)==null||e.remove(),window.removeEventListener("keydown",this.handleEscapePress)}async closeSearch(){this.removeHighlights(),this.lastLookuop&&this.lastLookuop.classList.remove("search-highlight"),await this.removeView(),this.resetState()}updateSearchResults(){this.searchResultsView.textContent=`${this.lookUpIndex+1||0} of ${this.searchResults.length||0}`}onSearchInput(){this.removeHighlights();const e=this.searchQueryInput.value;if(!e.trim()){this.searchResults=[],this.lookUpIndex=-1,this.updateSearchResults();return}this.searchResults=this.messages.filter(i=>i.textContent.toLowerCase().match(e.toLowerCase())&&e!==""),this.searchResults.length>0?(this.moveUpButton.disabled=!1,this.moveDownButton.disabled=!1):(this.moveUpButton.disabled=!0,this.moveDownButton.disabled=!0),this.lookUpIndex=0,this.goToSearchResult(this.lookUpIndex);const t=new RegExp(`(${e})`,"gi");this.searchResults.forEach(i=>{i.querySelectorAll("pre, p").forEach(n=>{const a=document.createTreeWalker(n,NodeFilter.SHOW_TEXT);let o;const r=[];for(;o=a.nextNode();)t.test(o.textContent)&&r.push(o);r.forEach(l=>{const c=document.createDocumentFragment();let p=l.textContent;p.replace(t,(m,f,x)=>{const v=p.slice(0,x);v&&c.appendChild(document.createTextNode(v));const w=document.createElement("span");w.className="highlight",w.textContent=m,c.appendChild(w),p=p.slice(x+m.length)}),p&&c.appendChild(document.createTextNode(p)),l.parentNode.replaceChild(c,l)})})})}goToSearchResult(e){e<0?this.lookUpIndex=0:e>this.searchResults.length-1?this.lookUpIndex=this.searchResults.length-1:this.lookUpIndex=e,this.moveDownButton.disabled=!1,this.moveUpButton.disabled=!1,this.lookUpIndex<=0&&(this.moveDownButton.disabled=!0),this.lookUpIndex>=this.searchResults.length-1&&(this.moveUpButton.disabled=!0),this.updateSearchResults(),this.lastLookuop&&this.lastLookuop.classList.remove("search-highlight");const t=this.searchResults[this.lookUpIndex];t&&(t.scrollIntoView({block:"center"}),this.lastLookuop=t,this.lastLookuop.classList.add("search-highlight"))}removeHighlights(){this.searchResults.forEach(e=>{e.classList.remove("search-highlight"),e.querySelectorAll("pre, p").forEach(i=>{const s=i.textContent;i.textContent=s})})}handleEscapePress(e){e.key==="Escape"&&this.destroy()}initEscapeKeyListener(){window.addEventListener("keydown",this.handleEscapePress)}}class ve{constructor(e){h(this,"typingIndicatorWrapper",d("div"));h(this,"parentElement",d("div"));h(this,"typingDots",[]);h(this,"AnimationConfig",{duration:1200,fill:"forwards",easing:"cubic-bezier(.48,.01,0,1)"});h(this,"isTyping",!1);this.parentElement=e,this.init()}init(){this.makeTypingIndicator()}makeTypingIndicator(){this.typingIndicatorWrapper=d("div","typing-indicator-wrapper active");const e=d("div","typing-indicator");[1,2,3].forEach(()=>{const t=d("div","typing-dot");e.appendChild(t),this.typingDots.push(t)}),this.typingIndicatorWrapper.style.opacity="0",this.typingIndicatorWrapper.style.transform="scale(0.5)",this.typingIndicatorWrapper.style.height="0px",this.typingIndicatorWrapper.appendChild(e)}show(){this.isTyping=!0,this.showTimeout&&(clearTimeout(this.showTimeout),this.showTimeout=null),this.parentElement.contains(this.typingIndicatorWrapper)&&this.parentElement.removeChild(this.typingIndicatorWrapper),this.parentElement.prepend(this.typingIndicatorWrapper),this.typingIndicatorWrapper.animate({height:this.typingIndicatorWrapper.scrollHeight+"px"},this.AnimationConfig),this.showTimeout=setTimeout(()=>{this.typingIndicatorWrapper.animate({transform:"scale(1)",opacity:"1"},this.AnimationConfig)},200)}hide(){this.isTyping=!1,this.hideTimeout&&(clearTimeout(this.hideTimeout),this.hideTimeout=null),this.typingIndicatorWrapper.offsetHeight+"",this.typingIndicatorWrapper.animate({transform:"scale(0.5)",opacity:"0",height:"0px"},this.AnimationConfig)}}let xe=class{constructor({conversationId:e,chatSelectsMap:t,conversationsMap:i,websocket:s,userId:n,deviceId:a,isAdmin:o,maxFileSize:r}){h(this,"chatSelectsMap");h(this,"conversationsMap");h(this,"conversationId");h(this,"conversation");h(this,"chatApp");h(this,"messageInputWrapper");h(this,"messageInput");h(this,"sendButton");h(this,"defaultEditableHeight");h(this,"defaultFooterHeight");h(this,"footer");h(this,"websocket");h(this,"userId");h(this,"deviceId");h(this,"timeFormatter",new Intl.DateTimeFormat("en-us",{timeStyle:"short"}));h(this,"AnimationConfig",{duration:1200,fill:"forwards",easing:"cubic-bezier(.48,.01,0,1)"});h(this,"files",{current:[]});h(this,"replyMessage",null);h(this,"typingIndicator",null);h(this,"receipient",{id:"",name:""});h(this,"isAdmin");this.chatSelectsMap=t,this.conversationsMap=i,this.conversationId=e,this.conversation=o?H(`.chat-app [data-conversation-id="${e}"]`):H(".chat-app .conversation"),this.websocket=s,this.userId=n,this.deviceId=a,this.isAdmin=o,this.maxFileSize=r,this.sendMessage=this.sendMessage.bind(this),this.syncDatePills=this.syncDatePills.bind(this),this.initSingleChat(),setInterval(this.syncDatePills,60*60*1e3),this.chatApp&&(this.chatApp.style.opacity="1");const l=H(".chat-app");l&&(l.style.opacity="1")}initSingleChat(){const e=g("div","chat-application"),t=this.createHeader();this.typingIndicator=new ve(this.conversation.firstElementChild),e.appendChild(t),this.conversation.replaceWith(e),e.appendChild(this.conversation),this.chatFooter=new ye({maxFileSize:this.maxFileSize,files:this.files,sendMessage:this.sendMessage,conversation:this.conversation,typingIndicator:this.typingIndicator,chatApp:e,container:e,websocket:this.websocket,syncDatePills:this.syncDatePills}),this.footer=this.chatFooter.footer,this.chatApp=e,this.initWebsocketListener(),this.initExistingMessages(),this.syncDatePills()}createHeader(){if(this.isAdmin){const e=this.chatSelectsMap[this.conversationId],t=e.dataset.category,i=g("div","header-wrapper"),s=g("header"),n=g("div","profile","",{"data-category":t}),a=g("button","close-chat");a.appendChild(y("caret-left")),a.onclick=()=>{this.closeChat()};const o=g("img",void 0,void 0,{src:e.querySelector("img").src}),r=g("h2",void 0,e.querySelector("h3").textContent);this.receipient.name=e.querySelector("h3").textContent;const l=g("button","clickable chat-search"),c=y("magnifying-glass",24);l.appendChild(c),n.append(a,o,r);const p=g("div","search-wrapper");return s.append(n,l),i.append(s,p),l.onclick=()=>{p.children.length==0&&new ne({container:p,messages:document.querySelectorAll(`.messages-wrapper[data-conversation-id='${this.conversationId}'] .message`)})},i}else{const e=g("header"),t=g("div","search-container");return document.querySelector(".chat-search").onclick=()=>{t.children.length==0&&new ne({container:t,messages:document.querySelectorAll(".messages-container .message")})},e.append(t),e}}static getFileSize(e){const t=typeof e=="number"?e:e.size,i=t/1024,s=i/1024,n=s/1024,a=n/1024,o=a/1024;return o>=1?`${o.toFixed(2)} PB`:a>=1?`${a.toFixed(2)} TB`:n>=1?`${n.toFixed(2)} GB`:s>=1?`${s.toFixed(2)} MB`:i>=1?`${i.toFixed(2)} KB`:`${t.toFixed(2)} B`}sendMessage(e){this.websocket.readyState===WebSocket.OPEN&&this.websocket.send(JSON.stringify(e))}initWebsocketListener(){this.websocket.addEventListener("message",e=>{var i,s,n,a;const t=JSON.parse(e.data);switch(t.type){case"message_sent":if(t.conversation_id!==this.conversationId||t.deviceId===this.deviceId)return;const{message:o}=new K({text:t.message,id:t.message_id,isSent:!1,time:t.time,receivedFiles:t.sentFiles,senderId:t.sender_id,reply:t.reply,chat:this,isAdmin:this.isAdmin});this.typingIndicator.hide(),this.appendReceivedMessage(o,t);break;case"message_delivered":this.markMessageAsDelievered(t.message_id);break;case"active-typing":{if(t.conversation_id!==this.conversationId||t.deviceId===this.deviceId)return;this.typingIndicator.show()}break;case"idle-typing":{if(t.conversation_id!==this.conversationId||t.deviceId===this.deviceId)return;this.typingIndicator.hide()}break;case"edit_message":{const r=this.conversation.querySelector(`[data-id="${t.message_id}"]`);(s=(i=r==null?void 0:r.message)==null?void 0:i.updateMessageText)==null||s.call(i,t.message)}break;case"delete_message":{const r=this.conversation.querySelector(`[data-id="${t.message_id}"]`);(a=(n=r==null?void 0:r.message)==null?void 0:n.deleteMessage)==null||a.call(n)}break}})}appendReceivedMessage(e,t){e.style.height="0px",e.style.marginBottom="0px",e.style.padding="0px",e.style.opacity="0",e.style.transform="scale(0.5)",e.style.transformOrigin="bottom left";const i=g("div");i.style.display="flex",i.style.flexDirection="column",i.style.justifyContent="flex-end",i.appendChild(e),this.conversation.firstElementChild.prepend(i);const n=e.querySelector("pre").offsetHeight;let a=0;const o=e.querySelector(".reply-wrapper");o&&(a=o.offsetHeight);const r=32,l=14,c=80;i.animate({height:["0px",n+r+a+(t.sentFiles&&t.sentFiles.length>0?c:0)+l+"px"]},{duration:800,easing:"cubic-bezier(.17,.67,.16,.99)",fill:"forwards"});const p=e.animate({transform:["scale(0.5)","scale(1)"],opacity:["0","1"],height:["0px",n+r+a+(t.sentFiles&&t.sentFiles.length>0?c:0)+"px"],paddingLeft:["0px","8px"],paddingRight:["0px","8px"],paddingTop:["0px","8px"],paddingBottom:["0px","24px"],marginBottom:["0px","14px"],borderRadius:["0px 0px 0px 0px","10px 0px 10px 10px"]},{delay:100,duration:800,easing:"cubic-bezier(.17,.67,.16,.99)",fill:"forwards"});this.sendMessage({...t,type:"delivered_message",message_id:t.message_id,conversation_id:this.conversationId,sender_id:this.userId}),p.onfinish=()=>{i.replaceWith(e),p.commitStyles(),p.cancel(),e.style.transform="none",this.syncDatePills()}}markMessageAsDelievered(e){setTimeout(()=>{var i,s;const t=this.conversation.querySelector(`[data-id="${e}"]`);(s=(i=t==null?void 0:t.message)==null?void 0:i.markAsDelivered)==null||s.call(i)},1e3)}initExistingMessages(){this.conversation.querySelectorAll(".message").forEach(t=>{new K({messageElement:t,chat:this,isAdmin:this.isAdmin})})}createReplyMessage(e,t=!0){var m;const i=e.dataset,s=i.senderId===this.userId,n=i.id,a=g("div",`reply-wrapper ${i.type}`),o=g("div","reply-container"),r=g("p","user",s?"You":this.receipient.name),l=g("p","reply-message",(m=e.querySelector("pre"))==null?void 0:m.textContent),c=g("div","content-wrapper");c.append(r,l);const p=e.querySelector("img");if(o.append(c),p){const f=g("img","reply-image",void 0,{src:p.src});o.appendChild(f)}if(a.appendChild(o),t){const f=g("button","remove-reply clickable",void 0,{type:"button"}),x=()=>{a.remove(),this.replyMessage=null};f.onclick=()=>{x()},window.addEventListener("keydown",w=>{w.key==="Escape"&&x()});const v=y("close",8,"0 0 24 24");f.appendChild(v),o.appendChild(f)}return{replyWrapper:a,messageId:n}}appendReplyMessage(e){if(this.replyMessage)return;this.replyMessage=e;const{replyWrapper:t}=this.createReplyMessage(this.replyMessage);this.chatFooter.messageInputWrapper.prepend(t),this.chatFooter.messageInput.focus()}createMessageDropDownButton(e){const t=g("div","drop-down-wrapper"),i=g("div","drop-down-button"),s=y("caret-down");i.appendChild(s),t.appendChild(i),e.prepend(t)}forwardMessage(e,t){t.forEach(i=>{if(e.trim()==="")return;const s=new K({text:e,senderId:this.userId,isSent:!0,chat:this,isAdmin:this.isAdmin});document.querySelector(`.messages-wrapper[data-conversation-id='${i}']`).firstElementChild.prepend(s.message);const n=N(10),a={message_id:n,conversation_id:i,message:e,sender_id:this.userId,type:"send_message",time:this.timeFormatter.format(new Date)};s.updateMessageId(n),this.websocket.readyState===WebSocket.OPEN&&(this.sendMessage(a),s.markAsSent(a.time))})}async editMessage(e){this.prepareEditMode(e)}prepareEditMode(e){this.messageToEdit=e,this.chatFooter.messageInput.innerText=e.message.text,this.chatFooter.messageInput.focus();const t=document.createRange(),i=window.getSelection();t.selectNodeContents(this.chatFooter.messageInput),t.collapse(!1),i.removeAllRanges(),i.addRange(t),this.messageToEdit.style.transformOrigin="bottom right",this.messageToEdit.animate({zIndex:["0","5"],boxShadow:["0px 0px 0px 100vmax rgba(0,0,0,0)","0px 0px 0px 100vmax rgba(0,0,0,0.4)"],transform:["scale(1)","scale(1.05)"]},this.AnimationConfig),this.removeEditModeButton=g("button","remove-edit-mode"),this.removeEditModeButton.appendChild(y("close")),this.removeEditModeButton.onclick=()=>{this.removeEditMode()},this.removeEditModeButton.style.transform="scale(0.5)",this.removeEditModeButton.style.opacity="0",this.attachmentWrapperWidth=this.attachmentWrapper.offsetWidth;const s=this.attachmentWrapper.animate({transform:["scale(1)","scale(0.5)"],opacity:["1","0"]},{...this.AnimationConfig,duration:750});s.onfinish=()=>{this.attachmentWrapper.replaceWith(this.removeEditModeButton),this.removeEditModeButton.animate({transform:["scale(0.5)","scale(1)"],opacity:["0","1"]},{...this.AnimationConfig,duration:750})}}removeEditMode(){this.messageToEdit.style.transformOrigin="";const e=this.messageToEdit.animate({zIndex:["5","0"],boxShadow:["0px 0px 0px 100vmax rgba(0,0,0,0.4)","0px 0px 0px 100vmax rgba(0,0,0,0)"],transform:["scale(1.05)","scale(1)"]},this.AnimationConfig);this.chatFooter.messageInput.innerText="",this.chatFooter.messageInput.focus(),e.onfinish=()=>{e.cancel(),this.messageToEdit.style.zIndex="auto",this.messageToEdit.style.transform="none",this.messageToEdit=null};const t=this.removeEditModeButton.animate({transform:["scale(1)","scale(0.5)"],opacity:["1","0"]},{...this.AnimationConfig,duration:750});t.onfinish=()=>{this.removeEditModeButton.replaceWith(this.attachmentWrapper),this.attachmentWrapper.animate({transform:["scale(0.5)","scale(1)"],opacity:["0","1"]},{...this.AnimationConfig,duration:750}),this.removeEditModeButton=null}}deleteMessage(e){this.sendMessage({message_id:e,conversation_id:this.conversationId,type:"delete_message"})}closeChat(){const e=H(".recents"),t=H(".chat-app");e.classList.add("active"),t.classList.remove("active")}syncDatePills(){const e=this.conversation.querySelectorAll(".message"),t=new Map;e.forEach(s=>{const n=new Date(s.dataset.time).toDateString();t.has(n)||t.set(n,[]),t.get(n).push(s)});const i=new Map;this.conversation.querySelectorAll(".pill").forEach(s=>{const n=new Date(s.dataset.time).toDateString();i.set(n,s)});for(const[s,n]of t.entries()){const a=n[n.length-1],o=this.getFriendlyDateLabel(new Date(a.dataset.time));if(i.has(s)){const r=i.get(s);r.textContent=o,r.previousSibling!==a&&a.parentNode.insertBefore(r,a.nextSibling)}else{const r=document.createElement("div");r.className="pill",r.dataset.time=a.dataset.time,r.textContent=o,a.parentNode.insertBefore(r,a.nextSibling)}}}getFriendlyDateLabel(e){const t=new Date,i=new Date(e.getFullYear(),e.getMonth(),e.getDate()),n=(new Date(t.getFullYear(),t.getMonth(),t.getDate())-i)/(1e3*60*60*24);return n===0?"Today":n===1?"Yesterday":e.toLocaleDateString(void 0,{weekday:"long",year:"numeric",month:"short",day:"numeric"})}};export{xe as C,K as M};
